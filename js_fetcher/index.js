"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path = __importStar(require("path"));
const argv_1 = __importDefault(require("argv"));
const lodash_get_1 = __importDefault(require("lodash.get"));
const winston = __importStar(require("winston"));
// import Olm before importing js-sdk to prevent it crying
global.Olm = require('olm');
const matrix_js_sdk_1 = require("matrix-js-sdk");
// side-effect upgrade MatrixClient prototype
require("./matrix_client_ext");
const Queue = require('better-queue');
const SqliteStore = require('better-queue-sqlite');
const request = require('request-promise');
const LocalStorageCryptoStore = require('matrix-js-sdk/lib/crypto/store/localStorage-crypto-store').default;
argv_1.default.option([
    {
        name: 'config',
        type: 'path',
        description: 'Path to the JSON config file',
    }, {
        name: 'data',
        type: 'path',
        description: 'Path to the data directory',
    }, {
        name: 'matrix-search-url',
        type: 'string',
        description: 'The address:port of the matrix-search Go server',
    },
]);
const args = argv_1.default.run();
// Loading localStorage module
if (typeof global.localStorage === "undefined" || global.localStorage === null)
    global.localStorage = new (require('node-localstorage').LocalStorage)(path.join(args.options['data'], 'js_fetcher.localStorage'));
matrix_js_sdk_1.setCryptoStoreFactory(() => new LocalStorageCryptoStore(global.localStorage));
const logger = new winston.Logger({
    level: 'info',
    transports: [
        new winston.transports.Console({ colorize: true })
    ]
});
class BleveHttp {
    constructor(baseUrl) {
        this.request = request.defaults({ baseUrl });
    }
    enqueue(events) {
        return this.request({
            url: 'enqueue',
            method: 'POST',
            json: true,
            body: events,
        });
    }
}
function indexable(ev) {
    return indexableKeys.some((key) => lodash_get_1.default(ev, key) !== undefined);
}
setup().then();
// debug disable js-sdk log spam
const disableConsoleLogger = false;
if (disableConsoleLogger) {
    console.log = function () { };
    console.warn = function () { };
    console.error = function () { };
    console.error = function () { };
}
const FILTER_BLOCK = {
    not_types: ['*'],
    limit: 0,
};
function onTaskQueued(task_id, ev) {
    const { room_id, event_id, sender, type } = ev;
    if (ev.redacts) {
        logger.info('enqueue event for redaction', { room_id, event_id, task_id });
    }
    else {
        logger.info('enqueue event for indexing', { room_id, event_id, sender, type, task_id });
    }
}
function onBatchFailed(error) {
    logger.error('batch failed', { error });
}
async function setup() {
    let config;
    try {
        config = require(args.options['config'] || 'config.json');
    }
    catch (e) {
        logger.error('failed to load config', e);
        return;
    }
    const b = new BleveHttp(args.options['matrix-search-url'] || "http://localhost:8000/api/");
    const q = new Queue(async (batch, cb) => {
        try {
            cb(null, await b.enqueue(batch));
        }
        catch (e) {
            cb(e);
        }
    }, {
        batchSize: 100,
        maxRetries: 100,
        retryDelay: 5000,
        store: new SqliteStore({
            path: path.join(args.options['data'], 'js_fetcher.queue.sqlite'),
        }),
    });
    q.on('task_queued', onTaskQueued);
    q.on('batch_failed', onBatchFailed);
    const cli = matrix_js_sdk_1.createClient({
        baseUrl: config['hs_url'],
        idBaseUrl: '',
        userId: config['user_id'],
        deviceId: config['device_id'],
        accessToken: config['access_token'],
        useAuthorizationHeader: true,
        store: new matrix_js_sdk_1.MatrixInMemoryStore({
            localStorage: global.localStorage,
        }),
        sessionStore: new matrix_js_sdk_1.WebStorageSessionStore(global.localStorage),
    });
    cli.on('event', (event) => {
        if (event.isEncrypted())
            return;
        const cev = event.getClearEvent();
        // if event can be redacted or is a redaction then enqueue it for processing
        if (event.getType() === "m.room.redaction" || !indexable(cev))
            return;
        return q.push(cev);
    });
    cli.on('Event.decrypted', (event) => {
        if (event.isDecryptionFailure()) {
            logger.warn('decryption failure', { event: event.event });
            return;
        }
        const cev = event.getClearEvent();
        if (!indexable(cev))
            return;
        return q.push(cev);
    });
    // cli.on('Room.redaction', (event: MatrixEvent) => {
    //     return q.push({
    //         type: JobType.redact,
    //         event: event.getClearEvent(),
    //     });
    // });
    try {
        logger.info('initializing crypto');
        await cli.initCrypto();
    }
    catch (error) {
        logger.error('failed to init crypto', { error });
        process.exit(-1);
    }
    logger.info('crypto initialized');
    // create sync filter
    const filter = new matrix_js_sdk_1.Filter(cli.credentials.userId);
    filter.setDefinition({
        room: {
            include_leave: false,
            // ephemeral: FILTER_BLOCK, // we don't care about ephemeral events
            account_data: FILTER_BLOCK,
            // state: FILTER_BLOCK, // TODO: do we care about state
            timeline: {
                limit: 20,
            },
        },
        presence: FILTER_BLOCK,
        account_data: FILTER_BLOCK,
    });
    try {
        logger.info('loading/creating sync filter');
        filter.filterId = await cli.getOrCreateFilter(filterName(cli), filter);
    }
    catch (error) {
        logger.error('failed to getOrCreate sync filter', { error });
        process.exit(-1);
    }
    logger.info('sync filter loaded', { filter_id: filter.getFilterId() });
    logger.info('starting client');
    // filter sync to improve performance
    cli.startClient({
        disablePresence: true,
        filter,
    });
    logger.info('client started - fetcher has begun');
}
// TODO groups-pagination
// TODO backfill
// TODO gapfill
function filterName(cli) {
    return `MATRIX_SEARCH_FILTER_${cli.credentials.userId}`;
}
var RequestKey;
(function (RequestKey) {
    RequestKey["body"] = "content.body";
    RequestKey["name"] = "content.name";
    RequestKey["topic"] = "content.topic";
})(RequestKey || (RequestKey = {}));
const indexableKeys = [RequestKey.body, RequestKey.name, RequestKey.topic];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNkI7QUFRN0IsZ0RBQXdCO0FBQ3hCLDREQUE2QjtBQUM3QixpREFBbUM7QUFJbkMsMERBQTBEO0FBQzFELE1BQU0sQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRTVCLGlEQWdCdUI7QUFDdkIsNkNBQTZDO0FBQzdDLCtCQUE2QjtBQUU3QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDdEMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDbkQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFFM0MsTUFBTSx1QkFBdUIsR0FBRyxPQUFPLENBQUMsMERBQTBELENBQUMsQ0FBQyxPQUFPLENBQUM7QUFFNUcsY0FBSSxDQUFDLE1BQU0sQ0FBQztJQUNSO1FBQ0ksSUFBSSxFQUFFLFFBQVE7UUFDZCxJQUFJLEVBQUUsTUFBTTtRQUNaLFdBQVcsRUFBRSw4QkFBOEI7S0FDOUMsRUFBRTtRQUNDLElBQUksRUFBRSxNQUFNO1FBQ1osSUFBSSxFQUFFLE1BQU07UUFDWixXQUFXLEVBQUUsNEJBQTRCO0tBQzVDLEVBQUU7UUFDQyxJQUFJLEVBQUUsbUJBQW1CO1FBQ3pCLElBQUksRUFBRSxRQUFRO1FBQ2QsV0FBVyxFQUFFLGlEQUFpRDtLQUNqRTtDQUNKLENBQUMsQ0FBQztBQUNILE1BQU0sSUFBSSxHQUFHLGNBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUV4Qiw4QkFBOEI7QUFDOUIsSUFBSSxPQUFPLE1BQU0sQ0FBQyxZQUFZLEtBQUssV0FBVyxJQUFJLE1BQU0sQ0FBQyxZQUFZLEtBQUssSUFBSTtJQUMxRSxNQUFNLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMs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RUFBRSxJQUFJO1FBQ3JCLE1BQU07S0FDVCxDQUFDLENBQUM7SUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxDQUFDLENBQUM7QUFDdEQsQ0FBQztBQUVELHlCQUF5QjtBQUN6QixnQkFBZ0I7QUFDaEIsZUFBZTtBQUVmLG9CQUFvQixHQUFpQjtJQUNqQyxPQUFPLHdCQUF3QixHQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQzVELENBQUM7QUFFRCxJQUFLLFVBSUo7QUFKRCxXQUFLLFVBQVU7SUFDWCxtQ0FBcUIsQ0FBQTtJQUNyQixtQ0FBcUIsQ0FBQTtJQUNyQixxQ0FBdUIsQ0FBQTtBQUMzQixDQUFDLEVBSkksVUFBVSxLQUFWLFVBQVUsUUFJZDtBQUVELE1BQU0sYUFBYSxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcblxuZGVjbGFyZSB2YXIgZ2xvYmFsOiB7XG4gICAgT2xtOiBhbnlcbiAgICBsb2NhbFN0b3JhZ2U/OiBhbnlcbiAgICBhdG9iOiAoc3RyaW5nKSA9PiBzdHJpbmc7XG59O1xuXG5pbXBvcnQgYXJndiBmcm9tICdhcmd2JztcbmltcG9ydCBnZXQgZnJvbSAnbG9kYXNoLmdldCc7XG5pbXBvcnQgKiBhcyB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xuaW1wb3J0IHtSZXF1ZXN0UHJvbWlzZSwgUmVxdWVzdFByb21pc2VPcHRpb25zfSBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHtSZXF1ZXN0QVBJLCBSZXF1aXJlZFVyaVVybH0gZnJvbSAncmVxdWVzdCc7XG5cbi8vIGltcG9ydCBPbG0gYmVmb3JlIGltcG9ydGluZyBqcy1zZGsgdG8gcHJldmVudCBpdCBjcnlpbmdcbmdsb2JhbC5PbG0gPSByZXF1aXJlKCdvbG0nKTtcblxuaW1wb3J0IHtcbiAgICBSb29tLFxuICAgIEV2ZW50LFxuICAgIEZpbHRlcixcbiAgICBNYXRyaXgsXG4gICAgTWF0cml4RXZlbnQsXG4gICAgVXNlclByb2ZpbGUsXG4gICAgY3JlYXRlQ2xpZW50LFxuICAgIEV2ZW50Q29udGV4dCxcbiAgICBNYXRyaXhDbGllbnQsXG4gICAgSW5kZXhlZERCU3RvcmUsXG4gICAgRXZlbnRXaXRoQ29udGV4dCxcbiAgICBNYXRyaXhJbk1lbW9yeVN0b3JlLFxuICAgIEluZGV4ZWREQkNyeXB0b1N0b3JlLFxuICAgIHNldENyeXB0b1N0b3JlRmFjdG9yeSxcbiAgICBXZWJTdG9yYWdlU2Vzc2lvblN0b3JlLFxufSBmcm9tICdtYXRyaXgtanMtc2RrJztcbi8vIHNpZGUtZWZmZWN0IHVwZ3JhZGUgTWF0cml4Q2xpZW50IHByb3RvdHlwZVxuaW1wb3J0ICcuL21hdHJpeF9jbGllbnRfZXh0JztcblxuY29uc3QgUXVldWUgPSByZXF1aXJlKCdiZXR0ZXItcXVldWUnKTtcbmNvbnN0IFNxbGl0ZVN0b3JlID0gcmVxdWlyZSgnYmV0dGVyLXF1ZXVlLXNxbGl0ZScpO1xuY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZScpO1xuXG5jb25zdCBMb2NhbFN0b3JhZ2VDcnlwdG9TdG9yZSA9IHJlcXVpcmUoJ21hdHJpeC1qcy1zZGsvbGliL2NyeXB0by9zdG9yZS9sb2NhbFN0b3JhZ2UtY3J5cHRvLXN0b3JlJykuZGVmYXVsdDtcblxuYXJndi5vcHRpb24oW1xuICAgIHtcbiAgICAgICAgbmFtZTogJ2NvbmZpZycsXG4gICAgICAgIHR5cGU6ICdwYXRoJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdQYXRoIHRvIHRoZSBKU09OIGNvbmZpZyBmaWxlJyxcbiAgICB9LCB7XG4gICAgICAgIG5hbWU6ICdkYXRhJyxcbiAgICAgICAgdHlwZTogJ3BhdGgnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1BhdGggdG8gdGhlIGRhdGEgZGlyZWN0b3J5JyxcbiAgICB9LCB7XG4gICAgICAgIG5hbWU6ICdtYXRyaXgtc2VhcmNoLXVybCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBhZGRyZXNzOnBvcnQgb2YgdGhlIG1hdHJpeC1zZWFyY2ggR28gc2VydmVyJyxcbiAgICB9LFxuXSk7XG5jb25zdCBhcmdzID0gYXJndi5ydW4oKTtcblxuLy8gTG9hZGluZyBsb2NhbFN0b3JhZ2UgbW9kdWxlXG5pZiAodHlwZW9mIGdsb2JhbC5sb2NhbFN0b3JhZ2UgPT09IFwidW5kZWZpbmVkXCIgfHwgZ2xvYmFsLmxvY2FsU3RvcmFnZSA9PT0gbnVsbClcbiAgICBnbG9iYWwubG9jYWxTdG9yYWdlID0gbmV3IChyZXF1aXJlKCdub2RlLWxvY2Fsc3RvcmFnZScpLkxvY2FsU3RvcmFnZSkocGF0aC5qb2luKGFyZ3Mub3B0aW9uc1snZGF0YSddLCAnanNfZmV0Y2hlci5sb2NhbFN0b3JhZ2UnKSk7XG5cbnNldENyeXB0b1N0b3JlRmFjdG9yeSgoKSA9PiBuZXcgTG9jYWxTdG9yYWdlQ3J5cHRvU3RvcmUoZ2xvYmFsLmxvY2FsU3RvcmFnZSkpO1xuXG5cbmNvbnN0IGxvZ2dlciA9IG5ldyB3aW5zdG9uLkxvZ2dlcih7XG4gICAgbGV2ZWw6ICdpbmZvJyxcbiAgICB0cmFuc3BvcnRzOiBbXG4gICAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSh7Y29sb3JpemU6IHRydWV9KVxuICAgIF1cbn0pO1xuXG5jbGFzcyBCbGV2ZUh0dHAge1xuICAgIHJlcXVlc3Q6IFJlcXVlc3RBUEk8UmVxdWVzdFByb21pc2UsIFJlcXVlc3RQcm9taXNlT3B0aW9ucywgUmVxdWlyZWRVcmlVcmw+O1xuXG4gICAgY29uc3RydWN0b3IoYmFzZVVybDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3QuZGVmYXVsdHMoe2Jhc2VVcmx9KTtcbiAgICB9XG5cbiAgICBlbnF1ZXVlKGV2ZW50czogQXJyYXk8RXZlbnQ+KSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3Qoe1xuICAgICAgICAgICAgdXJsOiAnZW5xdWV1ZScsXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGpzb246IHRydWUsXG4gICAgICAgICAgICBib2R5OiBldmVudHMsXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaW5kZXhhYmxlKGV2OiBFdmVudCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBpbmRleGFibGVLZXlzLnNvbWUoKGtleTogc3RyaW5nKSA9PiBnZXQoZXYsIGtleSkgIT09IHVuZGVmaW5lZCk7XG59XG5cbnNldHVwKCkudGhlbigpO1xuXG4vLyBkZWJ1ZyBkaXNhYmxlIGpzLXNkayBsb2cgc3BhbVxuY29uc3QgZGlzYWJsZUNvbnNvbGVMb2dnZXIgPSBmYWxzZTtcbmlmIChkaXNhYmxlQ29uc29sZUxvZ2dlcikge1xuICAgIGNvbnNvbGUubG9nID0gZnVuY3Rpb24oKXt9O1xuICAgIGNvbnNvbGUud2FybiA9IGZ1bmN0aW9uKCl7fTtcbiAgICBjb25zb2xlLmVycm9yID0gZnVuY3Rpb24oKXt9O1xuICAgIGNvbnNvbGUuZXJyb3IgPSBmdW5jdGlvbigpe307XG59XG5cbmNvbnN0IEZJTFRFUl9CTE9DSyA9IHtcbiAgICBub3RfdHlwZXM6IFsnKiddLFxuICAgIGxpbWl0OiAwLFxufTtcblxuZnVuY3Rpb24gb25UYXNrUXVldWVkKHRhc2tfaWQ6IHN0cmluZywgZXY6IEV2ZW50KSB7XG4gICAgY29uc3Qge3Jvb21faWQsIGV2ZW50X2lkLCBzZW5kZXIsIHR5cGV9ID0gZXY7XG4gICAgaWYgKGV2LnJlZGFjdHMpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ2VucXVldWUgZXZlbnQgZm9yIHJlZGFjdGlvbicsIHtyb29tX2lkLCBldmVudF9pZCwgdGFza19pZH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdlbnF1ZXVlIGV2ZW50IGZvciBpbmRleGluZycsIHtyb29tX2lkLCBldmVudF9pZCwgc2VuZGVyLCB0eXBlLCB0YXNrX2lkfSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBvbkJhdGNoRmFpbGVkKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdiYXRjaCBmYWlsZWQnLCB7ZXJyb3J9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0dXAoKSB7XG4gICAgbGV0IGNvbmZpZztcbiAgICB0cnkge1xuICAgICAgICBjb25maWcgPSByZXF1aXJlKGFyZ3Mub3B0aW9uc1snY29uZmlnJ10gfHwgJ2NvbmZpZy5qc29uJyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ2ZhaWxlZCB0byBsb2FkIGNvbmZpZycsIGUpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYiA9IG5ldyBCbGV2ZUh0dHAoYXJncy5vcHRpb25zWydtYXRyaXgtc2VhcmNoLXVybCddIHx8IFwiaHR0cDovL2xvY2FsaG9zdDo4MDAwL2FwaS9cIik7XG5cbiAgICBjb25zdCBxID0gbmV3IFF1ZXVlKGFzeW5jIChiYXRjaDogQXJyYXk8RXZlbnQ+LCBjYikgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY2IobnVsbCwgYXdhaXQgYi5lbnF1ZXVlKGJhdGNoKSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGNiKGUpO1xuICAgICAgICB9XG4gICAgfSwge1xuICAgICAgICBiYXRjaFNpemU6IDEwMCxcbiAgICAgICAgbWF4UmV0cmllczogMTAwLFxuICAgICAgICByZXRyeURlbGF5OiA1MDAwLFxuICAgICAgICBzdG9yZTogbmV3IFNxbGl0ZVN0b3JlKHtcbiAgICAgICAgICAgIHBhdGg6IHBhdGguam9pbihhcmdzLm9wdGlvbnNbJ2RhdGEnXSwgJ2pzX2ZldGNoZXIucXVldWUuc3FsaXRlJyksXG4gICAgICAgIH0pLFxuICAgIH0pO1xuXG4gICAgcS5vbigndGFza19xdWV1ZWQnLCBvblRhc2tRdWV1ZWQpO1xuICAgIHEub24oJ2JhdGNoX2ZhaWxlZCcsIG9uQmF0Y2hGYWlsZWQpO1xuXG4gICAgY29uc3QgY2xpOiBNYXRyaXhDbGllbnQgPSBjcmVhdGVDbGllbnQoe1xuICAgICAgICBiYXNlVXJsOiBjb25maWdbJ2hzX3VybCddLFxuICAgICAgICBpZEJhc2VVcmw6ICcnLFxuICAgICAgICB1c2VySWQ6IGNvbmZpZ1sndXNlcl9pZCddLFxuICAgICAgICBkZXZpY2VJZDogY29uZmlnWydkZXZpY2VfaWQnXSxcbiAgICAgICAgYWNjZXNzVG9rZW46IGNvbmZpZ1snYWNjZXNzX3Rva2VuJ10sXG4gICAgICAgIHVzZUF1dGhvcml6YXRpb25IZWFkZXI6IHRydWUsXG4gICAgICAgIHN0b3JlOiBuZXcgTWF0cml4SW5NZW1vcnlTdG9yZSh7XG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2U6IGdsb2JhbC5sb2NhbFN0b3JhZ2UsXG4gICAgICAgIH0pLFxuICAgICAgICBzZXNzaW9uU3RvcmU6IG5ldyBXZWJTdG9yYWdlU2Vzc2lvblN0b3JlKGdsb2JhbC5sb2NhbFN0b3JhZ2UpLFxuICAgIH0pO1xuXG4gICAgY2xpLm9uKCdldmVudCcsIChldmVudDogTWF0cml4RXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGV2ZW50LmlzRW5jcnlwdGVkKCkpIHJldHVybjtcblxuICAgICAgICBjb25zdCBjZXYgPSBldmVudC5nZXRDbGVhckV2ZW50KCk7XG4gICAgICAgIC8vIGlmIGV2ZW50IGNhbiBiZSByZWRhY3RlZCBvciBpcyBhIHJlZGFjdGlvbiB0aGVuIGVucXVldWUgaXQgZm9yIHByb2Nlc3NpbmdcbiAgICAgICAgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gXCJtLnJvb20ucmVkYWN0aW9uXCIgfHwgIWluZGV4YWJsZShjZXYpKSByZXR1cm47XG4gICAgICAgIHJldHVybiBxLnB1c2goY2V2KTtcbiAgICB9KTtcbiAgICBjbGkub24oJ0V2ZW50LmRlY3J5cHRlZCcsIChldmVudDogTWF0cml4RXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGV2ZW50LmlzRGVjcnlwdGlvbkZhaWx1cmUoKSkge1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oJ2RlY3J5cHRpb24gZmFpbHVyZScsIHtldmVudDogZXZlbnQuZXZlbnR9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNldiA9IGV2ZW50LmdldENsZWFyRXZlbnQoKTtcbiAgICAgICAgaWYgKCFpbmRleGFibGUoY2V2KSkgcmV0dXJuO1xuICAgICAgICByZXR1cm4gcS5wdXNoKGNldik7XG4gICAgfSk7XG5cbiAgICAvLyBjbGkub24oJ1Jvb20ucmVkYWN0aW9uJywgKGV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgIC8vICAgICByZXR1cm4gcS5wdXNoKHtcbiAgICAvLyAgICAgICAgIHR5cGU6IEpvYlR5cGUucmVkYWN0LFxuICAgIC8vICAgICAgICAgZXZlbnQ6IGV2ZW50LmdldENsZWFyRXZlbnQoKSxcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gfSk7XG5cbiAgICB0cnkge1xuICAgICAgICBsb2dnZXIuaW5mbygnaW5pdGlhbGl6aW5nIGNyeXB0bycpO1xuICAgICAgICBhd2FpdCBjbGkuaW5pdENyeXB0bygpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignZmFpbGVkIHRvIGluaXQgY3J5cHRvJywge2Vycm9yfSk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgfVxuICAgIGxvZ2dlci5pbmZvKCdjcnlwdG8gaW5pdGlhbGl6ZWQnKTtcblxuICAgIC8vIGNyZWF0ZSBzeW5jIGZpbHRlclxuICAgIGNvbnN0IGZpbHRlciA9IG5ldyBGaWx0ZXIoY2xpLmNyZWRlbnRpYWxzLnVzZXJJZCk7XG4gICAgZmlsdGVyLnNldERlZmluaXRpb24oe1xuICAgICAgICByb29tOiB7XG4gICAgICAgICAgICBpbmNsdWRlX2xlYXZlOiBmYWxzZSwgLy8gVE9ETzogbm90IHN1cmUgaGVyZVxuICAgICAgICAgICAgLy8gZXBoZW1lcmFsOiBGSUxURVJfQkxPQ0ssIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgZXBoZW1lcmFsIGV2ZW50c1xuICAgICAgICAgICAgYWNjb3VudF9kYXRhOiBGSUxURVJfQkxPQ0ssIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgcm9vbSBhY2NvdW50X2RhdGFcbiAgICAgICAgICAgIC8vIHN0YXRlOiBGSUxURVJfQkxPQ0ssIC8vIFRPRE86IGRvIHdlIGNhcmUgYWJvdXQgc3RhdGVcbiAgICAgICAgICAgIHRpbWVsaW5lOiB7IC8vIFRPRE8gZG8gd2Ugd2FudCBhbGwgdGltZWxpbmUgZXZzXG4gICAgICAgICAgICAgICAgbGltaXQ6IDIwLCAvLyBncmFiIG1vcmUgZXZlbnRzIGZvciBlYWNoIHJvb20gdG8gYmVnaW4gd2l0aFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgcHJlc2VuY2U6IEZJTFRFUl9CTE9DSywgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBwcmVzZW5jZVxuICAgICAgICBhY2NvdW50X2RhdGE6IEZJTFRFUl9CTE9DSywgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBnbG9iYWwgYWNjb3VudF9kYXRhXG4gICAgfSk7XG5cbiAgICB0cnkge1xuICAgICAgICBsb2dnZXIuaW5mbygnbG9hZGluZy9jcmVhdGluZyBzeW5jIGZpbHRlcicpO1xuICAgICAgICBmaWx0ZXIuZmlsdGVySWQgPSBhd2FpdCBjbGkuZ2V0T3JDcmVhdGVGaWx0ZXIoZmlsdGVyTmFtZShjbGkpLCBmaWx0ZXIpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignZmFpbGVkIHRvIGdldE9yQ3JlYXRlIHN5bmMgZmlsdGVyJywge2Vycm9yfSk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgfVxuICAgIGxvZ2dlci5pbmZvKCdzeW5jIGZpbHRlciBsb2FkZWQnLCB7ZmlsdGVyX2lkOiBmaWx0ZXIuZ2V0RmlsdGVySWQoKX0pO1xuXG4gICAgbG9nZ2VyLmluZm8oJ3N0YXJ0aW5nIGNsaWVudCcpO1xuICAgIC8vIGZpbHRlciBzeW5jIHRvIGltcHJvdmUgcGVyZm9ybWFuY2VcbiAgICBjbGkuc3RhcnRDbGllbnQoe1xuICAgICAgICBkaXNhYmxlUHJlc2VuY2U6IHRydWUsXG4gICAgICAgIGZpbHRlcixcbiAgICB9KTtcbiAgICBsb2dnZXIuaW5mbygnY2xpZW50IHN0YXJ0ZWQgLSBmZXRjaGVyIGhhcyBiZWd1bicpO1xufVxuXG4vLyBUT0RPIGdyb3Vwcy1wYWdpbmF0aW9uXG4vLyBUT0RPIGJhY2tmaWxsXG4vLyBUT0RPIGdhcGZpbGxcblxuZnVuY3Rpb24gZmlsdGVyTmFtZShjbGk6IE1hdHJpeENsaWVudCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGBNQVRSSVhfU0VBUkNIX0ZJTFRFUl8ke2NsaS5jcmVkZW50aWFscy51c2VySWR9YDtcbn1cblxuZW51bSBSZXF1ZXN0S2V5IHtcbiAgICBib2R5ID0gXCJjb250ZW50LmJvZHlcIixcbiAgICBuYW1lID0gXCJjb250ZW50Lm5hbWVcIixcbiAgICB0b3BpYyA9IFwiY29udGVudC50b3BpY1wiLFxufVxuXG5jb25zdCBpbmRleGFibGVLZXlzID0gW1JlcXVlc3RLZXkuYm9keSwgUmVxdWVzdEtleS5uYW1lLCBSZXF1ZXN0S2V5LnRvcGljXTtcbiJdfQ==