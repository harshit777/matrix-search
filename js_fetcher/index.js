"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const argv_1 = __importDefault(require("argv"));
const lodash_get_1 = __importDefault(require("lodash.get"));
const winston = __importStar(require("winston"));
const mkdirp = __importStar(require("mkdirp"));
// import Olm before importing js-sdk to prevent it crying
global.Olm = require('olm');
const matrix_js_sdk_1 = require("matrix-js-sdk");
// side-effect upgrade MatrixClient prototype
require("./matrix_client_ext");
const Queue = require('better-queue');
const SqliteStore = require('better-queue-sqlite');
const request = require('request-promise');
const LocalStorageCryptoStore = require('matrix-js-sdk/lib/crypto/store/localStorage-crypto-store').default;
// create directory which will house the stores.
mkdirp.sync('./store');
// Loading localStorage module
if (typeof global.localStorage === "undefined" || global.localStorage === null)
    global.localStorage = new (require('node-localstorage').LocalStorage)('./store/localStorage');
matrix_js_sdk_1.setCryptoStoreFactory(() => new LocalStorageCryptoStore(global.localStorage));
argv_1.default.option([
    {
        name: 'url',
        type: 'string',
        description: 'The URL to be used to connect to the Matrix HS',
    }, {
        name: 'username',
        type: 'string',
        description: 'The username to be used to connect to the Matrix HS',
    }, {
        name: 'password',
        type: 'string',
        description: 'The password to be used to connect to the Matrix HS',
    }, {
        name: 'port',
        type: 'int',
        description: 'Port to bind to (default 8000)',
    }
]);
const logger = new winston.Logger({
    level: 'info',
    transports: [
        new winston.transports.Console({ colorize: true })
    ]
});
class BleveHttp {
    constructor(baseUrl) {
        this.request = request.defaults({ baseUrl });
    }
    enqueue(events) {
        return this.request({
            url: 'enqueue',
            method: 'POST',
            json: true,
            body: events,
        });
    }
}
const b = new BleveHttp("http://localhost:8000/api/");
function indexable(ev) {
    return indexableKeys.some((key) => lodash_get_1.default(ev, key) !== undefined);
}
const q = new Queue(async (batch, cb) => {
    try {
        cb(null, await b.enqueue(batch));
    }
    catch (e) {
        cb(e);
    }
}, {
    batchSize: 100,
    maxRetries: 100,
    retryDelay: 5000,
    store: new SqliteStore({
        path: './store/queue.sqlite',
    }),
});
q.on('task_queued', function (task_id, ev) {
    const { room_id, event_id, sender, type } = ev;
    if (ev.redacts) {
        logger.info('enqueue event for redaction', { room_id, event_id, task_id });
    }
    else {
        logger.info('enqueue event for indexing', { room_id, event_id, sender, type, task_id });
    }
});
q.on('batch_failed', function (error) {
    logger.error('batch failed', { error });
});
setup().then();
// debug disable js-sdk log spam
const disableConsoleLogger = false;
if (disableConsoleLogger) {
    console.log = function () { };
    console.warn = function () { };
    console.error = function () { };
    console.error = function () { };
}
const FILTER_BLOCK = {
    not_types: ['*'],
    limit: 0,
};
async function setup() {
    const args = argv_1.default.run();
    const baseUrl = args.options['url'] || 'https://matrix.org';
    let creds = {
        userId: global.localStorage.getItem('userId'),
        deviceId: global.localStorage.getItem('deviceId'),
        accessToken: global.localStorage.getItem('accessToken'),
    };
    if (!creds.userId || !creds.deviceId || !creds.accessToken) {
        if (!args.options['username'] || !args.options['password']) {
            logger.error('username and password were not specified on the commandline and none were saved');
            argv_1.default.help();
            process.exit(-1);
        }
        const loginClient = matrix_js_sdk_1.createClient({ baseUrl });
        try {
            const res = await loginClient.login('m.login.password', {
                user: args.options['username'],
                password: args.options['password'],
                initial_device_display_name: 'Matrix Search Daemon',
            });
            logger.info('logged in', { user_id: res.user_id });
            global.localStorage.setItem('userId', res.user_id);
            global.localStorage.setItem('deviceId', res.device_id);
            global.localStorage.setItem('accessToken', res.access_token);
            creds = {
                userId: res.user_id,
                deviceId: res.device_id,
                accessToken: res.access_token,
            };
        }
        catch (error) {
            logger.error('an error occurred logging in', { error });
            process.exit(1);
        }
    }
    const cli = matrix_js_sdk_1.createClient(Object.assign({ baseUrl, idBaseUrl: '' }, creds, { useAuthorizationHeader: true, store: new matrix_js_sdk_1.MatrixInMemoryStore({
            localStorage: global.localStorage,
        }), sessionStore: new matrix_js_sdk_1.WebStorageSessionStore(global.localStorage) }));
    cli.on('event', (event) => {
        if (event.isEncrypted())
            return;
        const cev = event.getClearEvent();
        // if event can be redacted or is a redaction then enqueue it for processing
        if (event.getType() === "m.room.redaction" || !indexable(cev))
            return;
        return q.push(cev);
    });
    cli.on('Event.decrypted', (event) => {
        if (event.isDecryptionFailure()) {
            logger.warn('decryption failure', { event: event.event });
            return;
        }
        const cev = event.getClearEvent();
        if (!indexable(cev))
            return;
        return q.push(cev);
    });
    // cli.on('Room.redaction', (event: MatrixEvent) => {
    //     return q.push({
    //         type: JobType.redact,
    //         event: event.getClearEvent(),
    //     });
    // });
    try {
        logger.info('initializing crypto');
        await cli.initCrypto();
    }
    catch (error) {
        logger.error('failed to init crypto', { error });
        process.exit(-1);
    }
    logger.info('crypto initialized');
    // create sync filter
    const filter = new matrix_js_sdk_1.Filter(cli.credentials.userId);
    filter.setDefinition({
        room: {
            include_leave: false,
            // ephemeral: FILTER_BLOCK, // we don't care about ephemeral events
            account_data: FILTER_BLOCK,
            // state: FILTER_BLOCK, // TODO: do we care about state
            timeline: {
                limit: 20,
            },
        },
        presence: FILTER_BLOCK,
        account_data: FILTER_BLOCK,
    });
    try {
        logger.info('loading/creating sync filter');
        filter.filterId = await cli.getOrCreateFilter(filterName(cli), filter);
    }
    catch (error) {
        logger.error('failed to getOrCreate sync filter', { error });
        process.exit(-1);
    }
    logger.info('sync filter loaded', { filter_id: filter.getFilterId() });
    logger.info('starting client');
    // filter sync to improve performance
    cli.startClient({
        disablePresence: true,
        filter,
    });
    logger.info('client started - fetcher has begun');
}
// TODO groups-pagination
// TODO backfill
// TODO gapfill
function filterName(cli) {
    return `MATRIX_SEARCH_FILTER_${cli.credentials.userId}`;
}
var RequestKey;
(function (RequestKey) {
    RequestKey["body"] = "content.body";
    RequestKey["name"] = "content.name";
    RequestKey["topic"] = "content.topic";
})(RequestKey || (RequestKey = {}));
const indexableKeys = [RequestKey.body, RequestKey.name, RequestKey.topic];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFNQSxnREFBd0I7QUFDeEIsNERBQTZCO0FBQzdCLGlEQUFtQztBQUNuQywrQ0FBaUM7QUFJakMsMERBQTBEO0FBQzFELE1BQU0sQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRTVCLGlEQWdCdUI7QUFDdkIsNkNBQTZDO0FBQzdDLCtCQUE2QjtBQUU3QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDdEMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDbkQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFFM0MsTUFBTSx1QkFBdUIsR0FBRyxPQUFPLENBQUMsMERBQTBELENBQUMsQ0FBQyxPQUFPLENBQUM7QUFFNUcsZ0RBQWdEO0FBQ2hELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDdkIsOEJBQThCO0FBQzlCLElBQUksT0FBTyxNQUFNLENBQUMsWUFBWSxLQUFLLFdBQVcsSUFBSSxNQUFNLENBQUMsWUFBWSxLQUFLLElBQUk7SUFDMUUsTUFBTSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUVsRyxxQ0FBcUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0FBRTlFLGNBQUksQ0FBQyxNQUFNLENBQUM7SUFDUjtRQUNJLElBQUksRUFBRSxLQUFLO1FBQ1gsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsZ0RBQWdEO0tBQ2hFLEVBQUU7UUFDQyxJQUFJLEVBQUUsVUFBVTtR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O0lBRXJFLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUMvQixxQ0FBcUM7SUFDckMsR0FBRyxDQUFDLFdBQVcsQ0FBQztRQUNaLGVBQWUsRUFBRSxJQUFJO1FBQ3JCLE1BQU07S0FDVCxDQUFDLENBQUM7SUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxDQUFDLENBQUM7QUFDdEQsQ0FBQztBQUVELHlCQUF5QjtBQUN6QixnQkFBZ0I7QUFDaEIsZUFBZTtBQUVmLG9CQUFvQixHQUFpQjtJQUNqQyxPQUFPLHdCQUF3QixHQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQzVELENBQUM7QUFFRCxJQUFLLFVBSUo7QUFKRCxXQUFLLFVBQVU7SUFDWCxtQ0FBcUIsQ0FBQTtJQUNyQixtQ0FBcUIsQ0FBQTtJQUNyQixxQ0FBdUIsQ0FBQTtBQUMzQixDQUFDLEVBSkksVUFBVSxLQUFWLFVBQVUsUUFJZDtBQUVELE1BQU0sYUFBYSxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImRlY2xhcmUgdmFyIGdsb2JhbDoge1xuICAgIE9sbTogYW55XG4gICAgbG9jYWxTdG9yYWdlPzogYW55XG4gICAgYXRvYjogKHN0cmluZykgPT4gc3RyaW5nO1xufTtcblxuaW1wb3J0IGFyZ3YgZnJvbSAnYXJndic7XG5pbXBvcnQgZ2V0IGZyb20gJ2xvZGFzaC5nZXQnO1xuaW1wb3J0ICogYXMgd2luc3RvbiBmcm9tICd3aW5zdG9uJztcbmltcG9ydCAqIGFzIG1rZGlycCBmcm9tICdta2RpcnAnO1xuaW1wb3J0IHtSZXF1ZXN0UHJvbWlzZSwgUmVxdWVzdFByb21pc2VPcHRpb25zfSBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHtSZXF1ZXN0QVBJLCBSZXF1aXJlZFVyaVVybH0gZnJvbSAncmVxdWVzdCc7XG5cbi8vIGltcG9ydCBPbG0gYmVmb3JlIGltcG9ydGluZyBqcy1zZGsgdG8gcHJldmVudCBpdCBjcnlpbmdcbmdsb2JhbC5PbG0gPSByZXF1aXJlKCdvbG0nKTtcblxuaW1wb3J0IHtcbiAgICBSb29tLFxuICAgIEV2ZW50LFxuICAgIEZpbHRlcixcbiAgICBNYXRyaXgsXG4gICAgTWF0cml4RXZlbnQsXG4gICAgVXNlclByb2ZpbGUsXG4gICAgY3JlYXRlQ2xpZW50LFxuICAgIEV2ZW50Q29udGV4dCxcbiAgICBNYXRyaXhDbGllbnQsXG4gICAgSW5kZXhlZERCU3RvcmUsXG4gICAgRXZlbnRXaXRoQ29udGV4dCxcbiAgICBNYXRyaXhJbk1lbW9yeVN0b3JlLFxuICAgIEluZGV4ZWREQkNyeXB0b1N0b3JlLFxuICAgIHNldENyeXB0b1N0b3JlRmFjdG9yeSxcbiAgICBXZWJTdG9yYWdlU2Vzc2lvblN0b3JlLFxufSBmcm9tICdtYXRyaXgtanMtc2RrJztcbi8vIHNpZGUtZWZmZWN0IHVwZ3JhZGUgTWF0cml4Q2xpZW50IHByb3RvdHlwZVxuaW1wb3J0ICcuL21hdHJpeF9jbGllbnRfZXh0JztcblxuY29uc3QgUXVldWUgPSByZXF1aXJlKCdiZXR0ZXItcXVldWUnKTtcbmNvbnN0IFNxbGl0ZVN0b3JlID0gcmVxdWlyZSgnYmV0dGVyLXF1ZXVlLXNxbGl0ZScpO1xuY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZScpO1xuXG5jb25zdCBMb2NhbFN0b3JhZ2VDcnlwdG9TdG9yZSA9IHJlcXVpcmUoJ21hdHJpeC1qcy1zZGsvbGliL2NyeXB0by9zdG9yZS9sb2NhbFN0b3JhZ2UtY3J5cHRvLXN0b3JlJykuZGVmYXVsdDtcblxuLy8gY3JlYXRlIGRpcmVjdG9yeSB3aGljaCB3aWxsIGhvdXNlIHRoZSBzdG9yZXMuXG5ta2RpcnAuc3luYygnLi9zdG9yZScpO1xuLy8gTG9hZGluZyBsb2NhbFN0b3JhZ2UgbW9kdWxlXG5pZiAodHlwZW9mIGdsb2JhbC5sb2NhbFN0b3JhZ2UgPT09IFwidW5kZWZpbmVkXCIgfHwgZ2xvYmFsLmxvY2FsU3RvcmFnZSA9PT0gbnVsbClcbiAgICBnbG9iYWwubG9jYWxTdG9yYWdlID0gbmV3IChyZXF1aXJlKCdub2RlLWxvY2Fsc3RvcmFnZScpLkxvY2FsU3RvcmFnZSkoJy4vc3RvcmUvbG9jYWxTdG9yYWdlJyk7XG5cbnNldENyeXB0b1N0b3JlRmFjdG9yeSgoKSA9PiBuZXcgTG9jYWxTdG9yYWdlQ3J5cHRvU3RvcmUoZ2xvYmFsLmxvY2FsU3RvcmFnZSkpO1xuXG5hcmd2Lm9wdGlvbihbXG4gICAge1xuICAgICAgICBuYW1lOiAndXJsJyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIFVSTCB0byBiZSB1c2VkIHRvIGNvbm5lY3QgdG8gdGhlIE1hdHJpeCBIUycsXG4gICAgfSwge1xuICAgICAgICBuYW1lOiAndXNlcm5hbWUnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgdXNlcm5hbWUgdG8gYmUgdXNlZCB0byBjb25uZWN0IHRvIHRoZSBNYXRyaXggSFMnLFxuICAgIH0sIHtcbiAgICAgICAgbmFtZTogJ3Bhc3N3b3JkJyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIHBhc3N3b3JkIHRvIGJlIHVzZWQgdG8gY29ubmVjdCB0byB0aGUgTWF0cml4IEhTJyxcbiAgICB9LCB7XG4gICAgICAgIG5hbWU6ICdwb3J0JyxcbiAgICAgICAgdHlwZTogJ2ludCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnUG9ydCB0byBiaW5kIHRvIChkZWZhdWx0IDgwMDApJyxcbiAgICB9XG5dKTtcblxuY29uc3QgbG9nZ2VyID0gbmV3IHdpbnN0b24uTG9nZ2VyKHtcbiAgICBsZXZlbDogJ2luZm8nLFxuICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKHtjb2xvcml6ZTogdHJ1ZX0pXG4gICAgXVxufSk7XG5cbmNsYXNzIEJsZXZlSHR0cCB7XG4gICAgcmVxdWVzdDogUmVxdWVzdEFQSTxSZXF1ZXN0UHJvbWlzZSwgUmVxdWVzdFByb21pc2VPcHRpb25zLCBSZXF1aXJlZFVyaVVybD47XG5cbiAgICBjb25zdHJ1Y3RvcihiYXNlVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdC5kZWZhdWx0cyh7YmFzZVVybH0pO1xuICAgIH1cblxuICAgIGVucXVldWUoZXZlbnRzOiBBcnJheTxFdmVudD4pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdCh7XG4gICAgICAgICAgICB1cmw6ICdlbnF1ZXVlJyxcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgICAgICAgIGJvZHk6IGV2ZW50cyxcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5jb25zdCBiID0gbmV3IEJsZXZlSHR0cChcImh0dHA6Ly9sb2NhbGhvc3Q6ODAwMC9hcGkvXCIpO1xuXG5mdW5jdGlvbiBpbmRleGFibGUoZXY6IEV2ZW50KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGluZGV4YWJsZUtleXMuc29tZSgoa2V5OiBzdHJpbmcpID0+IGdldChldiwga2V5KSAhPT0gdW5kZWZpbmVkKTtcbn1cblxuY29uc3QgcSA9IG5ldyBRdWV1ZShhc3luYyAoYmF0Y2g6IEFycmF5PEV2ZW50PiwgY2IpID0+IHtcbiAgICB0cnkge1xuICAgICAgICBjYihudWxsLCBhd2FpdCBiLmVucXVldWUoYmF0Y2gpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNiKGUpO1xuICAgIH1cbn0sIHtcbiAgICBiYXRjaFNpemU6IDEwMCxcbiAgICBtYXhSZXRyaWVzOiAxMDAsXG4gICAgcmV0cnlEZWxheTogNTAwMCxcbiAgICBzdG9yZTogbmV3IFNxbGl0ZVN0b3JlKHtcbiAgICAgICAgcGF0aDogJy4vc3RvcmUvcXVldWUuc3FsaXRlJyxcbiAgICB9KSxcbn0pO1xuXG5xLm9uKCd0YXNrX3F1ZXVlZCcsIGZ1bmN0aW9uKHRhc2tfaWQ6IHN0cmluZywgZXY6IEV2ZW50KSB7XG4gICAgY29uc3Qge3Jvb21faWQsIGV2ZW50X2lkLCBzZW5kZXIsIHR5cGV9ID0gZXY7XG4gICAgaWYgKGV2LnJlZGFjdHMpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ2VucXVldWUgZXZlbnQgZm9yIHJlZGFjdGlvbicsIHtyb29tX2lkLCBldmVudF9pZCwgdGFza19pZH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdlbnF1ZXVlIGV2ZW50IGZvciBpbmRleGluZycsIHtyb29tX2lkLCBldmVudF9pZCwgc2VuZGVyLCB0eXBlLCB0YXNrX2lkfSk7XG4gICAgfVxufSk7XG5cbnEub24oJ2JhdGNoX2ZhaWxlZCcsIGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdiYXRjaCBmYWlsZWQnLCB7ZXJyb3J9KTtcbn0pO1xuXG5zZXR1cCgpLnRoZW4oKTtcblxuLy8gZGVidWcgZGlzYWJsZSBqcy1zZGsgbG9nIHNwYW1cbmNvbnN0IGRpc2FibGVDb25zb2xlTG9nZ2VyID0gZmFsc2U7XG5pZiAoZGlzYWJsZUNvbnNvbGVMb2dnZXIpIHtcbiAgICBjb25zb2xlLmxvZyA9IGZ1bmN0aW9uKCl7fTtcbiAgICBjb25zb2xlLndhcm4gPSBmdW5jdGlvbigpe307XG4gICAgY29uc29sZS5lcnJvciA9IGZ1bmN0aW9uKCl7fTtcbiAgICBjb25zb2xlLmVycm9yID0gZnVuY3Rpb24oKXt9O1xufVxuXG5jb25zdCBGSUxURVJfQkxPQ0sgPSB7XG4gICAgbm90X3R5cGVzOiBbJyonXSxcbiAgICBsaW1pdDogMCxcbn07XG5cbmFzeW5jIGZ1bmN0aW9uIHNldHVwKCkge1xuICAgIGNvbnN0IGFyZ3MgPSBhcmd2LnJ1bigpO1xuXG4gICAgY29uc3QgYmFzZVVybCA9IGFyZ3Mub3B0aW9uc1sndXJsJ10gfHwgJ2h0dHBzOi8vbWF0cml4Lm9yZyc7XG5cbiAgICBsZXQgY3JlZHMgPSB7XG4gICAgICAgIHVzZXJJZDogZ2xvYmFsLmxvY2FsU3RvcmFnZS5nZXRJdGVtKCd1c2VySWQnKSxcbiAgICAgICAgZGV2aWNlSWQ6IGdsb2JhbC5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZGV2aWNlSWQnKSxcbiAgICAgICAgYWNjZXNzVG9rZW46IGdsb2JhbC5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnYWNjZXNzVG9rZW4nKSxcbiAgICB9O1xuXG4gICAgaWYgKCFjcmVkcy51c2VySWQgfHwgIWNyZWRzLmRldmljZUlkIHx8ICFjcmVkcy5hY2Nlc3NUb2tlbikge1xuICAgICAgICBpZiAoIWFyZ3Mub3B0aW9uc1sndXNlcm5hbWUnXSB8fCAhYXJncy5vcHRpb25zWydwYXNzd29yZCddKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ3VzZXJuYW1lIGFuZCBwYXNzd29yZCB3ZXJlIG5vdCBzcGVjaWZpZWQgb24gdGhlIGNvbW1hbmRsaW5lIGFuZCBub25lIHdlcmUgc2F2ZWQnKTtcbiAgICAgICAgICAgIGFyZ3YuaGVscCgpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGxvZ2luQ2xpZW50OiBNYXRyaXhDbGllbnQgPSBjcmVhdGVDbGllbnQoe2Jhc2VVcmx9KTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgbG9naW5DbGllbnQubG9naW4oJ20ubG9naW4ucGFzc3dvcmQnLCB7XG4gICAgICAgICAgICAgICAgdXNlcjogYXJncy5vcHRpb25zWyd1c2VybmFtZSddLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBhcmdzLm9wdGlvbnNbJ3Bhc3N3b3JkJ10sXG4gICAgICAgICAgICAgICAgaW5pdGlhbF9kZXZpY2VfZGlzcGxheV9uYW1lOiAnTWF0cml4IFNlYXJjaCBEYWVtb24nLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCdsb2dnZWQgaW4nLCB7dXNlcl9pZDogcmVzLnVzZXJfaWR9KTtcbiAgICAgICAgICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcklkJywgcmVzLnVzZXJfaWQpO1xuICAgICAgICAgICAgZ2xvYmFsLmxvY2FsU3RvcmFnZS5zZXRJdGVtKCdkZXZpY2VJZCcsIHJlcy5kZXZpY2VfaWQpO1xuICAgICAgICAgICAgZ2xvYmFsLmxvY2FsU3RvcmFnZS5zZXRJdGVtKCdhY2Nlc3NUb2tlbicsIHJlcy5hY2Nlc3NfdG9rZW4pO1xuXG4gICAgICAgICAgICBjcmVkcyA9IHtcbiAgICAgICAgICAgICAgICB1c2VySWQ6IHJlcy51c2VyX2lkLFxuICAgICAgICAgICAgICAgIGRldmljZUlkOiByZXMuZGV2aWNlX2lkLFxuICAgICAgICAgICAgICAgIGFjY2Vzc1Rva2VuOiByZXMuYWNjZXNzX3Rva2VuLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcignYW4gZXJyb3Igb2NjdXJyZWQgbG9nZ2luZyBpbicsIHtlcnJvcn0pO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgY2xpOiBNYXRyaXhDbGllbnQgPSBjcmVhdGVDbGllbnQoe1xuICAgICAgICBiYXNlVXJsLFxuICAgICAgICBpZEJhc2VVcmw6ICcnLFxuICAgICAgICAuLi5jcmVkcyxcbiAgICAgICAgdXNlQXV0aG9yaXphdGlvbkhlYWRlcjogdHJ1ZSxcbiAgICAgICAgc3RvcmU6IG5ldyBNYXRyaXhJbk1lbW9yeVN0b3JlKHtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZTogZ2xvYmFsLmxvY2FsU3RvcmFnZSxcbiAgICAgICAgfSksXG4gICAgICAgIHNlc3Npb25TdG9yZTogbmV3IFdlYlN0b3JhZ2VTZXNzaW9uU3RvcmUoZ2xvYmFsLmxvY2FsU3RvcmFnZSksXG4gICAgfSk7XG5cbiAgICBjbGkub24oJ2V2ZW50JywgKGV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQuaXNFbmNyeXB0ZWQoKSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IGNldiA9IGV2ZW50LmdldENsZWFyRXZlbnQoKTtcbiAgICAgICAgLy8gaWYgZXZlbnQgY2FuIGJlIHJlZGFjdGVkIG9yIGlzIGEgcmVkYWN0aW9uIHRoZW4gZW5xdWV1ZSBpdCBmb3IgcHJvY2Vzc2luZ1xuICAgICAgICBpZiAoZXZlbnQuZ2V0VHlwZSgpID09PSBcIm0ucm9vbS5yZWRhY3Rpb25cIiB8fCAhaW5kZXhhYmxlKGNldikpIHJldHVybjtcbiAgICAgICAgcmV0dXJuIHEucHVzaChjZXYpO1xuICAgIH0pO1xuICAgIGNsaS5vbignRXZlbnQuZGVjcnlwdGVkJywgKGV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQuaXNEZWNyeXB0aW9uRmFpbHVyZSgpKSB7XG4gICAgICAgICAgICBsb2dnZXIud2FybignZGVjcnlwdGlvbiBmYWlsdXJlJywge2V2ZW50OiBldmVudC5ldmVudH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2V2ID0gZXZlbnQuZ2V0Q2xlYXJFdmVudCgpO1xuICAgICAgICBpZiAoIWluZGV4YWJsZShjZXYpKSByZXR1cm47XG4gICAgICAgIHJldHVybiBxLnB1c2goY2V2KTtcbiAgICB9KTtcblxuICAgIC8vIGNsaS5vbignUm9vbS5yZWRhY3Rpb24nLCAoZXZlbnQ6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgLy8gICAgIHJldHVybiBxLnB1c2goe1xuICAgIC8vICAgICAgICAgdHlwZTogSm9iVHlwZS5yZWRhY3QsXG4gICAgLy8gICAgICAgICBldmVudDogZXZlbnQuZ2V0Q2xlYXJFdmVudCgpLFxuICAgIC8vICAgICB9KTtcbiAgICAvLyB9KTtcblxuICAgIHRyeSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdpbml0aWFsaXppbmcgY3J5cHRvJyk7XG4gICAgICAgIGF3YWl0IGNsaS5pbml0Q3J5cHRvKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdmYWlsZWQgdG8gaW5pdCBjcnlwdG8nLCB7ZXJyb3J9KTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oJ2NyeXB0byBpbml0aWFsaXplZCcpO1xuXG4gICAgLy8gY3JlYXRlIHN5bmMgZmlsdGVyXG4gICAgY29uc3QgZmlsdGVyID0gbmV3IEZpbHRlcihjbGkuY3JlZGVudGlhbHMudXNlcklkKTtcbiAgICBmaWx0ZXIuc2V0RGVmaW5pdGlvbih7XG4gICAgICAgIHJvb206IHtcbiAgICAgICAgICAgIGluY2x1ZGVfbGVhdmU6IGZhbHNlLCAvLyBUT0RPOiBub3Qgc3VyZSBoZXJlXG4gICAgICAgICAgICAvLyBlcGhlbWVyYWw6IEZJTFRFUl9CTE9DSywgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBlcGhlbWVyYWwgZXZlbnRzXG4gICAgICAgICAgICBhY2NvdW50X2RhdGE6IEZJTFRFUl9CTE9DSywgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCByb29tIGFjY291bnRfZGF0YVxuICAgICAgICAgICAgLy8gc3RhdGU6IEZJTFRFUl9CTE9DSywgLy8gVE9ETzogZG8gd2UgY2FyZSBhYm91dCBzdGF0ZVxuICAgICAgICAgICAgdGltZWxpbmU6IHsgLy8gVE9ETyBkbyB3ZSB3YW50IGFsbCB0aW1lbGluZSBldnNcbiAgICAgICAgICAgICAgICBsaW1pdDogMjAsIC8vIGdyYWIgbW9yZSBldmVudHMgZm9yIGVhY2ggcm9vbSB0byBiZWdpbiB3aXRoXG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBwcmVzZW5jZTogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IHByZXNlbmNlXG4gICAgICAgIGFjY291bnRfZGF0YTogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGdsb2JhbCBhY2NvdW50X2RhdGFcbiAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdsb2FkaW5nL2NyZWF0aW5nIHN5bmMgZmlsdGVyJyk7XG4gICAgICAgIGZpbHRlci5maWx0ZXJJZCA9IGF3YWl0IGNsaS5nZXRPckNyZWF0ZUZpbHRlcihmaWx0ZXJOYW1lKGNsaSksIGZpbHRlcik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdmYWlsZWQgdG8gZ2V0T3JDcmVhdGUgc3luYyBmaWx0ZXInLCB7ZXJyb3J9KTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oJ3N5bmMgZmlsdGVyIGxvYWRlZCcsIHtmaWx0ZXJfaWQ6IGZpbHRlci5nZXRGaWx0ZXJJZCgpfSk7XG5cbiAgICBsb2dnZXIuaW5mbygnc3RhcnRpbmcgY2xpZW50Jyk7XG4gICAgLy8gZmlsdGVyIHN5bmMgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZVxuICAgIGNsaS5zdGFydENsaWVudCh7XG4gICAgICAgIGRpc2FibGVQcmVzZW5jZTogdHJ1ZSxcbiAgICAgICAgZmlsdGVyLFxuICAgIH0pO1xuICAgIGxvZ2dlci5pbmZvKCdjbGllbnQgc3RhcnRlZCAtIGZldGNoZXIgaGFzIGJlZ3VuJyk7XG59XG5cbi8vIFRPRE8gZ3JvdXBzLXBhZ2luYXRpb25cbi8vIFRPRE8gYmFja2ZpbGxcbi8vIFRPRE8gZ2FwZmlsbFxuXG5mdW5jdGlvbiBmaWx0ZXJOYW1lKGNsaTogTWF0cml4Q2xpZW50KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYE1BVFJJWF9TRUFSQ0hfRklMVEVSXyR7Y2xpLmNyZWRlbnRpYWxzLnVzZXJJZH1gO1xufVxuXG5lbnVtIFJlcXVlc3RLZXkge1xuICAgIGJvZHkgPSBcImNvbnRlbnQuYm9keVwiLFxuICAgIG5hbWUgPSBcImNvbnRlbnQubmFtZVwiLFxuICAgIHRvcGljID0gXCJjb250ZW50LnRvcGljXCIsXG59XG5cbmNvbnN0IGluZGV4YWJsZUtleXMgPSBbUmVxdWVzdEtleS5ib2R5LCBSZXF1ZXN0S2V5Lm5hbWUsIFJlcXVlc3RLZXkudG9waWNdO1xuIl19