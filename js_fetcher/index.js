"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const argv_1 = __importDefault(require("argv"));
const lodash_get_1 = __importDefault(require("lodash.get"));
const winston = __importStar(require("winston"));
const mkdirp = __importStar(require("mkdirp"));
// import Olm before importing js-sdk to prevent it crying
global.Olm = require('olm');
const matrix_js_sdk_1 = require("matrix-js-sdk");
// side-effect upgrade MatrixClient prototype
require("./matrix_client_ext");
const Queue = require('better-queue');
const SqliteStore = require('better-queue-sqlite');
const request = require('request-promise');
const LocalStorageCryptoStore = require('matrix-js-sdk/lib/crypto/store/localStorage-crypto-store').default;
// create directory which will house the stores.
mkdirp.sync('./store');
// Loading localStorage module
if (typeof global.localStorage === "undefined" || global.localStorage === null)
    global.localStorage = new (require('node-localstorage').LocalStorage)('./store/localStorage');
matrix_js_sdk_1.setCryptoStoreFactory(() => new LocalStorageCryptoStore(global.localStorage));
argv_1.default.option([
    {
        name: 'config',
        type: 'path',
        description: 'Path to the JSON config file'
    }, {
        name: 'matrix-search-url',
        type: 'string',
        description: 'The address:port of the matrix-search Go server',
    },
]);
const logger = new winston.Logger({
    level: 'info',
    transports: [
        new winston.transports.Console({ colorize: true })
    ]
});
class BleveHttp {
    constructor(baseUrl) {
        this.request = request.defaults({ baseUrl });
    }
    enqueue(events) {
        return this.request({
            url: 'enqueue',
            method: 'POST',
            json: true,
            body: events,
        });
    }
}
function indexable(ev) {
    return indexableKeys.some((key) => lodash_get_1.default(ev, key) !== undefined);
}
setup().then();
// debug disable js-sdk log spam
const disableConsoleLogger = false;
if (disableConsoleLogger) {
    console.log = function () { };
    console.warn = function () { };
    console.error = function () { };
    console.error = function () { };
}
const FILTER_BLOCK = {
    not_types: ['*'],
    limit: 0,
};
function onTaskQueued(task_id, ev) {
    const { room_id, event_id, sender, type } = ev;
    if (ev.redacts) {
        logger.info('enqueue event for redaction', { room_id, event_id, task_id });
    }
    else {
        logger.info('enqueue event for indexing', { room_id, event_id, sender, type, task_id });
    }
}
function onBatchFailed(error) {
    logger.error('batch failed', { error });
}
async function setup() {
    const args = argv_1.default.run();
    let config;
    try {
        config = require(args.options['config'] || 'config.json');
    }
    catch (e) {
        logger.error('failed to load config', e);
        return;
    }
    const b = new BleveHttp(args.options['matrix-search-url'] || "http://localhost:8000/api/");
    const q = new Queue(async (batch, cb) => {
        try {
            cb(null, await b.enqueue(batch));
        }
        catch (e) {
            cb(e);
        }
    }, {
        batchSize: 100,
        maxRetries: 100,
        retryDelay: 5000,
        store: new SqliteStore({
            path: './store/queue.sqlite',
        }),
    });
    q.on('task_queued', onTaskQueued);
    q.on('batch_failed', onBatchFailed);
    const cli = matrix_js_sdk_1.createClient({
        baseUrl: config['hs_url'],
        idBaseUrl: '',
        userId: config['user_id'],
        deviceId: config['device_id'],
        accessToken: config['access_token'],
        useAuthorizationHeader: true,
        store: new matrix_js_sdk_1.MatrixInMemoryStore({
            localStorage: global.localStorage,
        }),
        sessionStore: new matrix_js_sdk_1.WebStorageSessionStore(global.localStorage),
    });
    cli.on('event', (event) => {
        if (event.isEncrypted())
            return;
        const cev = event.getClearEvent();
        // if event can be redacted or is a redaction then enqueue it for processing
        if (event.getType() === "m.room.redaction" || !indexable(cev))
            return;
        return q.push(cev);
    });
    cli.on('Event.decrypted', (event) => {
        if (event.isDecryptionFailure()) {
            logger.warn('decryption failure', { event: event.event });
            return;
        }
        const cev = event.getClearEvent();
        if (!indexable(cev))
            return;
        return q.push(cev);
    });
    // cli.on('Room.redaction', (event: MatrixEvent) => {
    //     return q.push({
    //         type: JobType.redact,
    //         event: event.getClearEvent(),
    //     });
    // });
    try {
        logger.info('initializing crypto');
        await cli.initCrypto();
    }
    catch (error) {
        logger.error('failed to init crypto', { error });
        process.exit(-1);
    }
    logger.info('crypto initialized');
    // create sync filter
    const filter = new matrix_js_sdk_1.Filter(cli.credentials.userId);
    filter.setDefinition({
        room: {
            include_leave: false,
            // ephemeral: FILTER_BLOCK, // we don't care about ephemeral events
            account_data: FILTER_BLOCK,
            // state: FILTER_BLOCK, // TODO: do we care about state
            timeline: {
                limit: 20,
            },
        },
        presence: FILTER_BLOCK,
        account_data: FILTER_BLOCK,
    });
    try {
        logger.info('loading/creating sync filter');
        filter.filterId = await cli.getOrCreateFilter(filterName(cli), filter);
    }
    catch (error) {
        logger.error('failed to getOrCreate sync filter', { error });
        process.exit(-1);
    }
    logger.info('sync filter loaded', { filter_id: filter.getFilterId() });
    logger.info('starting client');
    // filter sync to improve performance
    cli.startClient({
        disablePresence: true,
        filter,
    });
    logger.info('client started - fetcher has begun');
}
// TODO groups-pagination
// TODO backfill
// TODO gapfill
function filterName(cli) {
    return `MATRIX_SEARCH_FILTER_${cli.credentials.userId}`;
}
var RequestKey;
(function (RequestKey) {
    RequestKey["body"] = "content.body";
    RequestKey["name"] = "content.name";
    RequestKey["topic"] = "content.topic";
})(RequestKey || (RequestKey = {}));
const indexableKeys = [RequestKey.body, RequestKey.name, RequestKey.topic];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFNQSxnREFBd0I7QUFDeEIsNERBQTZCO0FBQzdCLGlEQUFtQztBQUNuQywrQ0FBaUM7QUFJakMsMERBQTBEO0FBQzFELE1BQU0sQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRTVCLGlEQWdCdUI7QUFDdkIsNkNBQTZDO0FBQzdDLCtCQUE2QjtBQUU3QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDdEMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDbkQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFFM0MsTUFBTSx1QkFBdUIsR0FBRyxPQUFPLENBQUMsMERBQTBELENBQUMsQ0FBQyxPQUFPLENBQUM7QUFFNUcsZ0RBQWdEO0FBQ2hELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDdkIsOEJBQThCO0FBQzlCLElBQUksT0FBTyxNQUFNLENBQUMsWUFBWSxLQUFLLFdBQVcsSUFBSSxNQUFNLENBQUMsWUFBWSxLQUFLLElBQUk7SUFDMUUsTUFBTSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUVsRyxxQ0FBcUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0FBRTlFLGNBQUksQ0FBQyxNQUFNLENBQUM7SUFDUjtRQUNJLElBQUksRUFBRSxRQUFRO1FBQ2QsSUFBSSxFQUFFLE1BQU07UUFDWixXQUFXLEVBQUUsOEJBQThCO0tBQzlDLEVBQUU7UUFDQyxJQUFJLEVBQUUsbUJBQW1C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QWlCO0lBQ2pDLE9BQU8sd0JBQXdCLEdBQUcsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDNUQsQ0FBQztBQUVELElBQUssVUFJSjtBQUpELFdBQUssVUFBVTtJQUNYLG1DQUFxQixDQUFBO0lBQ3JCLG1DQUFxQixDQUFBO0lBQ3JCLHFDQUF1QixDQUFBO0FBQzNCLENBQUMsRUFKSSxVQUFVLEtBQVYsVUFBVSxRQUlkO0FBRUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZGVjbGFyZSB2YXIgZ2xvYmFsOiB7XG4gICAgT2xtOiBhbnlcbiAgICBsb2NhbFN0b3JhZ2U/OiBhbnlcbiAgICBhdG9iOiAoc3RyaW5nKSA9PiBzdHJpbmc7XG59O1xuXG5pbXBvcnQgYXJndiBmcm9tICdhcmd2JztcbmltcG9ydCBnZXQgZnJvbSAnbG9kYXNoLmdldCc7XG5pbXBvcnQgKiBhcyB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xuaW1wb3J0ICogYXMgbWtkaXJwIGZyb20gJ21rZGlycCc7XG5pbXBvcnQge1JlcXVlc3RQcm9taXNlLCBSZXF1ZXN0UHJvbWlzZU9wdGlvbnN9IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQge1JlcXVlc3RBUEksIFJlcXVpcmVkVXJpVXJsfSBmcm9tICdyZXF1ZXN0JztcblxuLy8gaW1wb3J0IE9sbSBiZWZvcmUgaW1wb3J0aW5nIGpzLXNkayB0byBwcmV2ZW50IGl0IGNyeWluZ1xuZ2xvYmFsLk9sbSA9IHJlcXVpcmUoJ29sbScpO1xuXG5pbXBvcnQge1xuICAgIFJvb20sXG4gICAgRXZlbnQsXG4gICAgRmlsdGVyLFxuICAgIE1hdHJpeCxcbiAgICBNYXRyaXhFdmVudCxcbiAgICBVc2VyUHJvZmlsZSxcbiAgICBjcmVhdGVDbGllbnQsXG4gICAgRXZlbnRDb250ZXh0LFxuICAgIE1hdHJpeENsaWVudCxcbiAgICBJbmRleGVkREJTdG9yZSxcbiAgICBFdmVudFdpdGhDb250ZXh0LFxuICAgIE1hdHJpeEluTWVtb3J5U3RvcmUsXG4gICAgSW5kZXhlZERCQ3J5cHRvU3RvcmUsXG4gICAgc2V0Q3J5cHRvU3RvcmVGYWN0b3J5LFxuICAgIFdlYlN0b3JhZ2VTZXNzaW9uU3RvcmUsXG59IGZyb20gJ21hdHJpeC1qcy1zZGsnO1xuLy8gc2lkZS1lZmZlY3QgdXBncmFkZSBNYXRyaXhDbGllbnQgcHJvdG90eXBlXG5pbXBvcnQgJy4vbWF0cml4X2NsaWVudF9leHQnO1xuXG5jb25zdCBRdWV1ZSA9IHJlcXVpcmUoJ2JldHRlci1xdWV1ZScpO1xuY29uc3QgU3FsaXRlU3RvcmUgPSByZXF1aXJlKCdiZXR0ZXItcXVldWUtc3FsaXRlJyk7XG5jb25zdCByZXF1ZXN0ID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlJyk7XG5cbmNvbnN0IExvY2FsU3RvcmFnZUNyeXB0b1N0b3JlID0gcmVxdWlyZSgnbWF0cml4LWpzLXNkay9saWIvY3J5cHRvL3N0b3JlL2xvY2FsU3RvcmFnZS1jcnlwdG8tc3RvcmUnKS5kZWZhdWx0O1xuXG4vLyBjcmVhdGUgZGlyZWN0b3J5IHdoaWNoIHdpbGwgaG91c2UgdGhlIHN0b3Jlcy5cbm1rZGlycC5zeW5jKCcuL3N0b3JlJyk7XG4vLyBMb2FkaW5nIGxvY2FsU3RvcmFnZSBtb2R1bGVcbmlmICh0eXBlb2YgZ2xvYmFsLmxvY2FsU3RvcmFnZSA9PT0gXCJ1bmRlZmluZWRcIiB8fCBnbG9iYWwubG9jYWxTdG9yYWdlID09PSBudWxsKVxuICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UgPSBuZXcgKHJlcXVpcmUoJ25vZGUtbG9jYWxzdG9yYWdlJykuTG9jYWxTdG9yYWdlKSgnLi9zdG9yZS9sb2NhbFN0b3JhZ2UnKTtcblxuc2V0Q3J5cHRvU3RvcmVGYWN0b3J5KCgpID0+IG5ldyBMb2NhbFN0b3JhZ2VDcnlwdG9TdG9yZShnbG9iYWwubG9jYWxTdG9yYWdlKSk7XG5cbmFyZ3Yub3B0aW9uKFtcbiAgICB7XG4gICAgICAgIG5hbWU6ICdjb25maWcnLFxuICAgICAgICB0eXBlOiAncGF0aCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnUGF0aCB0byB0aGUgSlNPTiBjb25maWcgZmlsZSdcbiAgICB9LCB7XG4gICAgICAgIG5hbWU6ICdtYXRyaXgtc2VhcmNoLXVybCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBhZGRyZXNzOnBvcnQgb2YgdGhlIG1hdHJpeC1zZWFyY2ggR28gc2VydmVyJyxcbiAgICB9LFxuXSk7XG5cbmNvbnN0IGxvZ2dlciA9IG5ldyB3aW5zdG9uLkxvZ2dlcih7XG4gICAgbGV2ZWw6ICdpbmZvJyxcbiAgICB0cmFuc3BvcnRzOiBbXG4gICAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSh7Y29sb3JpemU6IHRydWV9KVxuICAgIF1cbn0pO1xuXG5jbGFzcyBCbGV2ZUh0dHAge1xuICAgIHJlcXVlc3Q6IFJlcXVlc3RBUEk8UmVxdWVzdFByb21pc2UsIFJlcXVlc3RQcm9taXNlT3B0aW9ucywgUmVxdWlyZWRVcmlVcmw+O1xuXG4gICAgY29uc3RydWN0b3IoYmFzZVVybDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3QuZGVmYXVsdHMoe2Jhc2VVcmx9KTtcbiAgICB9XG5cbiAgICBlbnF1ZXVlKGV2ZW50czogQXJyYXk8RXZlbnQ+KSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3Qoe1xuICAgICAgICAgICAgdXJsOiAnZW5xdWV1ZScsXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGpzb246IHRydWUsXG4gICAgICAgICAgICBib2R5OiBldmVudHMsXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaW5kZXhhYmxlKGV2OiBFdmVudCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBpbmRleGFibGVLZXlzLnNvbWUoKGtleTogc3RyaW5nKSA9PiBnZXQoZXYsIGtleSkgIT09IHVuZGVmaW5lZCk7XG59XG5cbnNldHVwKCkudGhlbigpO1xuXG4vLyBkZWJ1ZyBkaXNhYmxlIGpzLXNkayBsb2cgc3BhbVxuY29uc3QgZGlzYWJsZUNvbnNvbGVMb2dnZXIgPSBmYWxzZTtcbmlmIChkaXNhYmxlQ29uc29sZUxvZ2dlcikge1xuICAgIGNvbnNvbGUubG9nID0gZnVuY3Rpb24oKXt9O1xuICAgIGNvbnNvbGUud2FybiA9IGZ1bmN0aW9uKCl7fTtcbiAgICBjb25zb2xlLmVycm9yID0gZnVuY3Rpb24oKXt9O1xuICAgIGNvbnNvbGUuZXJyb3IgPSBmdW5jdGlvbigpe307XG59XG5cbmNvbnN0IEZJTFRFUl9CTE9DSyA9IHtcbiAgICBub3RfdHlwZXM6IFsnKiddLFxuICAgIGxpbWl0OiAwLFxufTtcblxuZnVuY3Rpb24gb25UYXNrUXVldWVkKHRhc2tfaWQ6IHN0cmluZywgZXY6IEV2ZW50KSB7XG4gICAgY29uc3Qge3Jvb21faWQsIGV2ZW50X2lkLCBzZW5kZXIsIHR5cGV9ID0gZXY7XG4gICAgaWYgKGV2LnJlZGFjdHMpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ2VucXVldWUgZXZlbnQgZm9yIHJlZGFjdGlvbicsIHtyb29tX2lkLCBldmVudF9pZCwgdGFza19pZH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdlbnF1ZXVlIGV2ZW50IGZvciBpbmRleGluZycsIHtyb29tX2lkLCBldmVudF9pZCwgc2VuZGVyLCB0eXBlLCB0YXNrX2lkfSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBvbkJhdGNoRmFpbGVkKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdiYXRjaCBmYWlsZWQnLCB7ZXJyb3J9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0dXAoKSB7XG4gICAgY29uc3QgYXJncyA9IGFyZ3YucnVuKCk7XG5cbiAgICBsZXQgY29uZmlnO1xuICAgIHRyeSB7XG4gICAgICAgIGNvbmZpZyA9IHJlcXVpcmUoYXJncy5vcHRpb25zWydjb25maWcnXSB8fCAnY29uZmlnLmpzb24nKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignZmFpbGVkIHRvIGxvYWQgY29uZmlnJywgZSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBiID0gbmV3IEJsZXZlSHR0cChhcmdzLm9wdGlvbnNbJ21hdHJpeC1zZWFyY2gtdXJsJ10gfHwgXCJodHRwOi8vbG9jYWxob3N0OjgwMDAvYXBpL1wiKTtcblxuICAgIGNvbnN0IHEgPSBuZXcgUXVldWUoYXN5bmMgKGJhdGNoOiBBcnJheTxFdmVudD4sIGNiKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjYihudWxsLCBhd2FpdCBiLmVucXVldWUoYmF0Y2gpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY2IoZSk7XG4gICAgICAgIH1cbiAgICB9LCB7XG4gICAgICAgIGJhdGNoU2l6ZTogMTAwLFxuICAgICAgICBtYXhSZXRyaWVzOiAxMDAsXG4gICAgICAgIHJldHJ5RGVsYXk6IDUwMDAsXG4gICAgICAgIHN0b3JlOiBuZXcgU3FsaXRlU3RvcmUoe1xuICAgICAgICAgICAgcGF0aDogJy4vc3RvcmUvcXVldWUuc3FsaXRlJyxcbiAgICAgICAgfSksXG4gICAgfSk7XG5cbiAgICBxLm9uKCd0YXNrX3F1ZXVlZCcsIG9uVGFza1F1ZXVlZCk7XG4gICAgcS5vbignYmF0Y2hfZmFpbGVkJywgb25CYXRjaEZhaWxlZCk7XG5cbiAgICBjb25zdCBjbGk6IE1hdHJpeENsaWVudCA9IGNyZWF0ZUNsaWVudCh7XG4gICAgICAgIGJhc2VVcmw6IGNvbmZpZ1snaHNfdXJsJ10sXG4gICAgICAgIGlkQmFzZVVybDogJycsXG4gICAgICAgIHVzZXJJZDogY29uZmlnWyd1c2VyX2lkJ10sXG4gICAgICAgIGRldmljZUlkOiBjb25maWdbJ2RldmljZV9pZCddLFxuICAgICAgICBhY2Nlc3NUb2tlbjogY29uZmlnWydhY2Nlc3NfdG9rZW4nXSxcbiAgICAgICAgdXNlQXV0aG9yaXphdGlvbkhlYWRlcjogdHJ1ZSxcbiAgICAgICAgc3RvcmU6IG5ldyBNYXRyaXhJbk1lbW9yeVN0b3JlKHtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZTogZ2xvYmFsLmxvY2FsU3RvcmFnZSxcbiAgICAgICAgfSksXG4gICAgICAgIHNlc3Npb25TdG9yZTogbmV3IFdlYlN0b3JhZ2VTZXNzaW9uU3RvcmUoZ2xvYmFsLmxvY2FsU3RvcmFnZSksXG4gICAgfSk7XG5cbiAgICBjbGkub24oJ2V2ZW50JywgKGV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQuaXNFbmNyeXB0ZWQoKSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IGNldiA9IGV2ZW50LmdldENsZWFyRXZlbnQoKTtcbiAgICAgICAgLy8gaWYgZXZlbnQgY2FuIGJlIHJlZGFjdGVkIG9yIGlzIGEgcmVkYWN0aW9uIHRoZW4gZW5xdWV1ZSBpdCBmb3IgcHJvY2Vzc2luZ1xuICAgICAgICBpZiAoZXZlbnQuZ2V0VHlwZSgpID09PSBcIm0ucm9vbS5yZWRhY3Rpb25cIiB8fCAhaW5kZXhhYmxlKGNldikpIHJldHVybjtcbiAgICAgICAgcmV0dXJuIHEucHVzaChjZXYpO1xuICAgIH0pO1xuICAgIGNsaS5vbignRXZlbnQuZGVjcnlwdGVkJywgKGV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQuaXNEZWNyeXB0aW9uRmFpbHVyZSgpKSB7XG4gICAgICAgICAgICBsb2dnZXIud2FybignZGVjcnlwdGlvbiBmYWlsdXJlJywge2V2ZW50OiBldmVudC5ldmVudH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2V2ID0gZXZlbnQuZ2V0Q2xlYXJFdmVudCgpO1xuICAgICAgICBpZiAoIWluZGV4YWJsZShjZXYpKSByZXR1cm47XG4gICAgICAgIHJldHVybiBxLnB1c2goY2V2KTtcbiAgICB9KTtcblxuICAgIC8vIGNsaS5vbignUm9vbS5yZWRhY3Rpb24nLCAoZXZlbnQ6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgLy8gICAgIHJldHVybiBxLnB1c2goe1xuICAgIC8vICAgICAgICAgdHlwZTogSm9iVHlwZS5yZWRhY3QsXG4gICAgLy8gICAgICAgICBldmVudDogZXZlbnQuZ2V0Q2xlYXJFdmVudCgpLFxuICAgIC8vICAgICB9KTtcbiAgICAvLyB9KTtcblxuICAgIHRyeSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdpbml0aWFsaXppbmcgY3J5cHRvJyk7XG4gICAgICAgIGF3YWl0IGNsaS5pbml0Q3J5cHRvKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdmYWlsZWQgdG8gaW5pdCBjcnlwdG8nLCB7ZXJyb3J9KTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oJ2NyeXB0byBpbml0aWFsaXplZCcpO1xuXG4gICAgLy8gY3JlYXRlIHN5bmMgZmlsdGVyXG4gICAgY29uc3QgZmlsdGVyID0gbmV3IEZpbHRlcihjbGkuY3JlZGVudGlhbHMudXNlcklkKTtcbiAgICBmaWx0ZXIuc2V0RGVmaW5pdGlvbih7XG4gICAgICAgIHJvb206IHtcbiAgICAgICAgICAgIGluY2x1ZGVfbGVhdmU6IGZhbHNlLCAvLyBUT0RPOiBub3Qgc3VyZSBoZXJlXG4gICAgICAgICAgICAvLyBlcGhlbWVyYWw6IEZJTFRFUl9CTE9DSywgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBlcGhlbWVyYWwgZXZlbnRzXG4gICAgICAgICAgICBhY2NvdW50X2RhdGE6IEZJTFRFUl9CTE9DSywgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCByb29tIGFjY291bnRfZGF0YVxuICAgICAgICAgICAgLy8gc3RhdGU6IEZJTFRFUl9CTE9DSywgLy8gVE9ETzogZG8gd2UgY2FyZSBhYm91dCBzdGF0ZVxuICAgICAgICAgICAgdGltZWxpbmU6IHsgLy8gVE9ETyBkbyB3ZSB3YW50IGFsbCB0aW1lbGluZSBldnNcbiAgICAgICAgICAgICAgICBsaW1pdDogMjAsIC8vIGdyYWIgbW9yZSBldmVudHMgZm9yIGVhY2ggcm9vbSB0byBiZWdpbiB3aXRoXG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBwcmVzZW5jZTogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IHByZXNlbmNlXG4gICAgICAgIGFjY291bnRfZGF0YTogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGdsb2JhbCBhY2NvdW50X2RhdGFcbiAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdsb2FkaW5nL2NyZWF0aW5nIHN5bmMgZmlsdGVyJyk7XG4gICAgICAgIGZpbHRlci5maWx0ZXJJZCA9IGF3YWl0IGNsaS5nZXRPckNyZWF0ZUZpbHRlcihmaWx0ZXJOYW1lKGNsaSksIGZpbHRlcik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdmYWlsZWQgdG8gZ2V0T3JDcmVhdGUgc3luYyBmaWx0ZXInLCB7ZXJyb3J9KTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oJ3N5bmMgZmlsdGVyIGxvYWRlZCcsIHtmaWx0ZXJfaWQ6IGZpbHRlci5nZXRGaWx0ZXJJZCgpfSk7XG5cbiAgICBsb2dnZXIuaW5mbygnc3RhcnRpbmcgY2xpZW50Jyk7XG4gICAgLy8gZmlsdGVyIHN5bmMgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZVxuICAgIGNsaS5zdGFydENsaWVudCh7XG4gICAgICAgIGRpc2FibGVQcmVzZW5jZTogdHJ1ZSxcbiAgICAgICAgZmlsdGVyLFxuICAgIH0pO1xuICAgIGxvZ2dlci5pbmZvKCdjbGllbnQgc3RhcnRlZCAtIGZldGNoZXIgaGFzIGJlZ3VuJyk7XG59XG5cbi8vIFRPRE8gZ3JvdXBzLXBhZ2luYXRpb25cbi8vIFRPRE8gYmFja2ZpbGxcbi8vIFRPRE8gZ2FwZmlsbFxuXG5mdW5jdGlvbiBmaWx0ZXJOYW1lKGNsaTogTWF0cml4Q2xpZW50KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYE1BVFJJWF9TRUFSQ0hfRklMVEVSXyR7Y2xpLmNyZWRlbnRpYWxzLnVzZXJJZH1gO1xufVxuXG5lbnVtIFJlcXVlc3RLZXkge1xuICAgIGJvZHkgPSBcImNvbnRlbnQuYm9keVwiLFxuICAgIG5hbWUgPSBcImNvbnRlbnQubmFtZVwiLFxuICAgIHRvcGljID0gXCJjb250ZW50LnRvcGljXCIsXG59XG5cbmNvbnN0IGluZGV4YWJsZUtleXMgPSBbUmVxdWVzdEtleS5ib2R5LCBSZXF1ZXN0S2V5Lm5hbWUsIFJlcXVlc3RLZXkudG9waWNdO1xuIl19