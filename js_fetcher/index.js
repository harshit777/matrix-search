"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path = __importStar(require("path"));
const argv_1 = __importDefault(require("argv"));
const lodash_get_1 = __importDefault(require("lodash.get"));
const winston = __importStar(require("winston"));
// import Olm before importing js-sdk to prevent it crying
global.Olm = require('olm');
const matrix_js_sdk_1 = require("matrix-js-sdk");
// side-effect upgrade MatrixClient prototype
require("./matrix_client_ext");
const Queue = require('better-queue');
const SqliteStore = require('better-queue-sqlite');
const request = require('request-promise');
const LocalStorageCryptoStore = require('matrix-js-sdk/lib/crypto/store/localStorage-crypto-store').default;
argv_1.default.option([
    {
        name: 'config',
        type: 'path',
        description: 'Path to the JSON config file',
    }, {
        name: 'data',
        type: 'path',
        description: 'Path to the data directory',
    }, {
        name: 'matrix-search-url',
        type: 'string',
        description: 'The address:port of the matrix-search Go server',
    },
]);
const args = argv_1.default.run();
// Loading localStorage module
if (typeof global.localStorage === "undefined" || global.localStorage === null)
    global.localStorage = new (require('node-localstorage').LocalStorage)(path.join(args.options['data'], 'localStorage'));
matrix_js_sdk_1.setCryptoStoreFactory(() => new LocalStorageCryptoStore(global.localStorage));
const logger = new winston.Logger({
    level: 'info',
    transports: [
        new winston.transports.Console({ colorize: true })
    ]
});
class BleveHttp {
    constructor(baseUrl) {
        this.request = request.defaults({ baseUrl });
    }
    enqueue(events) {
        return this.request({
            url: 'enqueue',
            method: 'POST',
            json: true,
            body: events,
        });
    }
}
function indexable(ev) {
    return indexableKeys.some((key) => lodash_get_1.default(ev, key) !== undefined);
}
setup().then();
// debug disable js-sdk log spam
const disableConsoleLogger = false;
if (disableConsoleLogger) {
    console.log = function () { };
    console.warn = function () { };
    console.error = function () { };
    console.error = function () { };
}
const FILTER_BLOCK = {
    not_types: ['*'],
    limit: 0,
};
function onTaskQueued(task_id, ev) {
    const { room_id, event_id, sender, type } = ev;
    if (ev.redacts) {
        logger.info('enqueue event for redaction', { room_id, event_id, task_id });
    }
    else {
        logger.info('enqueue event for indexing', { room_id, event_id, sender, type, task_id });
    }
}
function onBatchFailed(error) {
    logger.error('batch failed', { error });
}
async function setup() {
    let config;
    try {
        config = require(args.options['config'] || 'config.json');
    }
    catch (e) {
        logger.error('failed to load config', e);
        return;
    }
    const b = new BleveHttp(args.options['matrix-search-url'] || "http://localhost:8000/api/");
    const q = new Queue(async (batch, cb) => {
        try {
            cb(null, await b.enqueue(batch));
        }
        catch (e) {
            cb(e);
        }
    }, {
        batchSize: 100,
        maxRetries: 100,
        retryDelay: 5000,
        store: new SqliteStore({
            path: path.join(args.options['data'], 'js_fetcher.queue.sqlite'),
        }),
    });
    q.on('task_queued', onTaskQueued);
    q.on('batch_failed', onBatchFailed);
    const cli = matrix_js_sdk_1.createClient({
        baseUrl: config['hs_url'],
        idBaseUrl: '',
        userId: config['user_id'],
        deviceId: config['device_id'],
        accessToken: config['access_token'],
        useAuthorizationHeader: true,
        store: new matrix_js_sdk_1.MatrixInMemoryStore({
            localStorage: global.localStorage,
        }),
        sessionStore: new matrix_js_sdk_1.WebStorageSessionStore(global.localStorage),
    });
    cli.on('event', (event) => {
        if (event.isEncrypted())
            return;
        const cev = event.getClearEvent();
        // if event can be redacted or is a redaction then enqueue it for processing
        if (event.getType() === "m.room.redaction" || !indexable(cev))
            return;
        return q.push(cev);
    });
    cli.on('Event.decrypted', (event) => {
        if (event.isDecryptionFailure()) {
            logger.warn('decryption failure', { event: event.event });
            return;
        }
        const cev = event.getClearEvent();
        if (!indexable(cev))
            return;
        return q.push(cev);
    });
    // cli.on('Room.redaction', (event: MatrixEvent) => {
    //     return q.push({
    //         type: JobType.redact,
    //         event: event.getClearEvent(),
    //     });
    // });
    try {
        logger.info('initializing crypto');
        await cli.initCrypto();
    }
    catch (error) {
        logger.error('failed to init crypto', { error });
        process.exit(-1);
    }
    logger.info('crypto initialized');
    // create sync filter
    const filter = new matrix_js_sdk_1.Filter(cli.credentials.userId);
    filter.setDefinition({
        room: {
            include_leave: false,
            // ephemeral: FILTER_BLOCK, // we don't care about ephemeral events
            account_data: FILTER_BLOCK,
            // state: FILTER_BLOCK, // TODO: do we care about state
            timeline: {
                limit: 20,
            },
        },
        presence: FILTER_BLOCK,
        account_data: FILTER_BLOCK,
    });
    try {
        logger.info('loading/creating sync filter');
        filter.filterId = await cli.getOrCreateFilter(filterName(cli), filter);
    }
    catch (error) {
        logger.error('failed to getOrCreate sync filter', { error });
        process.exit(-1);
    }
    logger.info('sync filter loaded', { filter_id: filter.getFilterId() });
    logger.info('starting client');
    // filter sync to improve performance
    cli.startClient({
        disablePresence: true,
        filter,
    });
    logger.info('client started - fetcher has begun');
}
// TODO groups-pagination
// TODO backfill
// TODO gapfill
function filterName(cli) {
    return `MATRIX_SEARCH_FILTER_${cli.credentials.userId}`;
}
var RequestKey;
(function (RequestKey) {
    RequestKey["body"] = "content.body";
    RequestKey["name"] = "content.name";
    RequestKey["topic"] = "content.topic";
})(RequestKey || (RequestKey = {}));
const indexableKeys = [RequestKey.body, RequestKey.name, RequestKey.topic];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNkI7QUFRN0IsZ0RBQXdCO0FBQ3hCLDREQUE2QjtBQUM3QixpREFBbUM7QUFJbkMsMERBQTBEO0FBQzFELE1BQU0sQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRTVCLGlEQWdCdUI7QUFDdkIsNkNBQTZDO0FBQzdDLCtCQUE2QjtBQUU3QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDdEMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDbkQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFFM0MsTUFBTSx1QkFBdUIsR0FBRyxPQUFPLENBQUMsMERBQTBELENBQUMsQ0FBQyxPQUFPLENBQUM7QUFFNUcsY0FBSSxDQUFDLE1BQU0sQ0FBQztJQUNSO1FBQ0ksSUFBSSxFQUFFLFFBQVE7UUFDZCxJQUFJLEVBQUUsTUFBTTtRQUNaLFdBQVcsRUFBRSw4QkFBOEI7S0FDOUMsRUFBRTtRQUNDLElBQUksRUFBRSxNQUFNO1FBQ1osSUFBSSxFQUFFLE1BQU07UUFDWixXQUFXLEVBQUUsNEJBQTRCO0tBQzVDLEVBQUU7UUFDQyxJQUFJLEVBQUUsbUJBQW1CO1FBQ3pCLElBQUksRUFBRSxRQUFRO1FBQ2QsV0FBVyxFQUFFLGlEQUFpRDtLQUNqRTtDQUNKLENBQUMsQ0FBQztBQUNILE1BQU0sSUFBSSxHQUFHLGNBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUV4Qiw4QkFBOEI7QUFDOUIsSUFBSSxPQUFPLE1BQU0sQ0FBQyxZQUFZLEtBQUssV0FBVyxJQUFJLE1BQU0sQ0FBQyxZQUFZLEtBQUssSUFBSTtJQUMxRSxNQUFNLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMs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QUUsSUFBSTtRQUNyQixNQUFNO0tBQ1QsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0FBQ3RELENBQUM7QUFFRCx5QkFBeUI7QUFDekIsZ0JBQWdCO0FBQ2hCLGVBQWU7QUFFZixvQkFBb0IsR0FBaUI7SUFDakMsT0FBTyx3QkFBd0IsR0FBRyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUM1RCxDQUFDO0FBRUQsSUFBSyxVQUlKO0FBSkQsV0FBSyxVQUFVO0lBQ1gsbUNBQXFCLENBQUE7SUFDckIsbUNBQXFCLENBQUE7SUFDckIscUNBQXVCLENBQUE7QUFDM0IsQ0FBQyxFQUpJLFVBQVUsS0FBVixVQUFVLFFBSWQ7QUFFRCxNQUFNLGFBQWEsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5cbmRlY2xhcmUgdmFyIGdsb2JhbDoge1xuICAgIE9sbTogYW55XG4gICAgbG9jYWxTdG9yYWdlPzogYW55XG4gICAgYXRvYjogKHN0cmluZykgPT4gc3RyaW5nO1xufTtcblxuaW1wb3J0IGFyZ3YgZnJvbSAnYXJndic7XG5pbXBvcnQgZ2V0IGZyb20gJ2xvZGFzaC5nZXQnO1xuaW1wb3J0ICogYXMgd2luc3RvbiBmcm9tICd3aW5zdG9uJztcbmltcG9ydCB7UmVxdWVzdFByb21pc2UsIFJlcXVlc3RQcm9taXNlT3B0aW9uc30gZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCB7UmVxdWVzdEFQSSwgUmVxdWlyZWRVcmlVcmx9IGZyb20gJ3JlcXVlc3QnO1xuXG4vLyBpbXBvcnQgT2xtIGJlZm9yZSBpbXBvcnRpbmcganMtc2RrIHRvIHByZXZlbnQgaXQgY3J5aW5nXG5nbG9iYWwuT2xtID0gcmVxdWlyZSgnb2xtJyk7XG5cbmltcG9ydCB7XG4gICAgUm9vbSxcbiAgICBFdmVudCxcbiAgICBGaWx0ZXIsXG4gICAgTWF0cml4LFxuICAgIE1hdHJpeEV2ZW50LFxuICAgIFVzZXJQcm9maWxlLFxuICAgIGNyZWF0ZUNsaWVudCxcbiAgICBFdmVudENvbnRleHQsXG4gICAgTWF0cml4Q2xpZW50LFxuICAgIEluZGV4ZWREQlN0b3JlLFxuICAgIEV2ZW50V2l0aENvbnRleHQsXG4gICAgTWF0cml4SW5NZW1vcnlTdG9yZSxcbiAgICBJbmRleGVkREJDcnlwdG9TdG9yZSxcbiAgICBzZXRDcnlwdG9TdG9yZUZhY3RvcnksXG4gICAgV2ViU3RvcmFnZVNlc3Npb25TdG9yZSxcbn0gZnJvbSAnbWF0cml4LWpzLXNkayc7XG4vLyBzaWRlLWVmZmVjdCB1cGdyYWRlIE1hdHJpeENsaWVudCBwcm90b3R5cGVcbmltcG9ydCAnLi9tYXRyaXhfY2xpZW50X2V4dCc7XG5cbmNvbnN0IFF1ZXVlID0gcmVxdWlyZSgnYmV0dGVyLXF1ZXVlJyk7XG5jb25zdCBTcWxpdGVTdG9yZSA9IHJlcXVpcmUoJ2JldHRlci1xdWV1ZS1zcWxpdGUnKTtcbmNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0LXByb21pc2UnKTtcblxuY29uc3QgTG9jYWxTdG9yYWdlQ3J5cHRvU3RvcmUgPSByZXF1aXJlKCdtYXRyaXgtanMtc2RrL2xpYi9jcnlwdG8vc3RvcmUvbG9jYWxTdG9yYWdlLWNyeXB0by1zdG9yZScpLmRlZmF1bHQ7XG5cbmFyZ3Yub3B0aW9uKFtcbiAgICB7XG4gICAgICAgIG5hbWU6ICdjb25maWcnLFxuICAgICAgICB0eXBlOiAncGF0aCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnUGF0aCB0byB0aGUgSlNPTiBjb25maWcgZmlsZScsXG4gICAgfSwge1xuICAgICAgICBuYW1lOiAnZGF0YScsXG4gICAgICAgIHR5cGU6ICdwYXRoJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdQYXRoIHRvIHRoZSBkYXRhIGRpcmVjdG9yeScsXG4gICAgfSwge1xuICAgICAgICBuYW1lOiAnbWF0cml4LXNlYXJjaC11cmwnLFxuICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgYWRkcmVzczpwb3J0IG9mIHRoZSBtYXRyaXgtc2VhcmNoIEdvIHNlcnZlcicsXG4gICAgfSxcbl0pO1xuY29uc3QgYXJncyA9IGFyZ3YucnVuKCk7XG5cbi8vIExvYWRpbmcgbG9jYWxTdG9yYWdlIG1vZHVsZVxuaWYgKHR5cGVvZiBnbG9iYWwubG9jYWxTdG9yYWdlID09PSBcInVuZGVmaW5lZFwiIHx8IGdsb2JhbC5sb2NhbFN0b3JhZ2UgPT09IG51bGwpXG4gICAgZ2xvYmFsLmxvY2FsU3RvcmFnZSA9IG5ldyAocmVxdWlyZSgnbm9kZS1sb2NhbHN0b3JhZ2UnKS5Mb2NhbFN0b3JhZ2UpKHBhdGguam9pbihhcmdzLm9wdGlvbnNbJ2RhdGEnXSwgJ2xvY2FsU3RvcmFnZScpKTtcblxuc2V0Q3J5cHRvU3RvcmVGYWN0b3J5KCgpID0+IG5ldyBMb2NhbFN0b3JhZ2VDcnlwdG9TdG9yZShnbG9iYWwubG9jYWxTdG9yYWdlKSk7XG5cblxuY29uc3QgbG9nZ2VyID0gbmV3IHdpbnN0b24uTG9nZ2VyKHtcbiAgICBsZXZlbDogJ2luZm8nLFxuICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKHtjb2xvcml6ZTogdHJ1ZX0pXG4gICAgXVxufSk7XG5cbmNsYXNzIEJsZXZlSHR0cCB7XG4gICAgcmVxdWVzdDogUmVxdWVzdEFQSTxSZXF1ZXN0UHJvbWlzZSwgUmVxdWVzdFByb21pc2VPcHRpb25zLCBSZXF1aXJlZFVyaVVybD47XG5cbiAgICBjb25zdHJ1Y3RvcihiYXNlVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdC5kZWZhdWx0cyh7YmFzZVVybH0pO1xuICAgIH1cblxuICAgIGVucXVldWUoZXZlbnRzOiBBcnJheTxFdmVudD4pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdCh7XG4gICAgICAgICAgICB1cmw6ICdlbnF1ZXVlJyxcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgICAgICAgIGJvZHk6IGV2ZW50cyxcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBpbmRleGFibGUoZXY6IEV2ZW50KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGluZGV4YWJsZUtleXMuc29tZSgoa2V5OiBzdHJpbmcpID0+IGdldChldiwga2V5KSAhPT0gdW5kZWZpbmVkKTtcbn1cblxuc2V0dXAoKS50aGVuKCk7XG5cbi8vIGRlYnVnIGRpc2FibGUganMtc2RrIGxvZyBzcGFtXG5jb25zdCBkaXNhYmxlQ29uc29sZUxvZ2dlciA9IGZhbHNlO1xuaWYgKGRpc2FibGVDb25zb2xlTG9nZ2VyKSB7XG4gICAgY29uc29sZS5sb2cgPSBmdW5jdGlvbigpe307XG4gICAgY29uc29sZS53YXJuID0gZnVuY3Rpb24oKXt9O1xuICAgIGNvbnNvbGUuZXJyb3IgPSBmdW5jdGlvbigpe307XG4gICAgY29uc29sZS5lcnJvciA9IGZ1bmN0aW9uKCl7fTtcbn1cblxuY29uc3QgRklMVEVSX0JMT0NLID0ge1xuICAgIG5vdF90eXBlczogWycqJ10sXG4gICAgbGltaXQ6IDAsXG59O1xuXG5mdW5jdGlvbiBvblRhc2tRdWV1ZWQodGFza19pZDogc3RyaW5nLCBldjogRXZlbnQpIHtcbiAgICBjb25zdCB7cm9vbV9pZCwgZXZlbnRfaWQsIHNlbmRlciwgdHlwZX0gPSBldjtcbiAgICBpZiAoZXYucmVkYWN0cykge1xuICAgICAgICBsb2dnZXIuaW5mbygnZW5xdWV1ZSBldmVudCBmb3IgcmVkYWN0aW9uJywge3Jvb21faWQsIGV2ZW50X2lkLCB0YXNrX2lkfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ2VucXVldWUgZXZlbnQgZm9yIGluZGV4aW5nJywge3Jvb21faWQsIGV2ZW50X2lkLCBzZW5kZXIsIHR5cGUsIHRhc2tfaWR9KTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIG9uQmF0Y2hGYWlsZWQoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ2JhdGNoIGZhaWxlZCcsIHtlcnJvcn0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXR1cCgpIHtcbiAgICBsZXQgY29uZmlnO1xuICAgIHRyeSB7XG4gICAgICAgIGNvbmZpZyA9IHJlcXVpcmUoYXJncy5vcHRpb25zWydjb25maWcnXSB8fCAnY29uZmlnLmpzb24nKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignZmFpbGVkIHRvIGxvYWQgY29uZmlnJywgZSk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBiID0gbmV3IEJsZXZlSHR0cChhcmdzLm9wdGlvbnNbJ21hdHJpeC1zZWFyY2gtdXJsJ10gfHwgXCJodHRwOi8vbG9jYWxob3N0OjgwMDAvYXBpL1wiKTtcblxuICAgIGNvbnN0IHEgPSBuZXcgUXVldWUoYXN5bmMgKGJhdGNoOiBBcnJheTxFdmVudD4sIGNiKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjYihudWxsLCBhd2FpdCBiLmVucXVldWUoYmF0Y2gpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY2IoZSk7XG4gICAgICAgIH1cbiAgICB9LCB7XG4gICAgICAgIGJhdGNoU2l6ZTogMTAwLFxuICAgICAgICBtYXhSZXRyaWVzOiAxMDAsXG4gICAgICAgIHJldHJ5RGVsYXk6IDUwMDAsXG4gICAgICAgIHN0b3JlOiBuZXcgU3FsaXRlU3RvcmUoe1xuICAgICAgICAgICAgcGF0aDogcGF0aC5qb2luKGFyZ3Mub3B0aW9uc1snZGF0YSddLCAnanNfZmV0Y2hlci5xdWV1ZS5zcWxpdGUnKSxcbiAgICAgICAgfSksXG4gICAgfSk7XG5cbiAgICBxLm9uKCd0YXNrX3F1ZXVlZCcsIG9uVGFza1F1ZXVlZCk7XG4gICAgcS5vbignYmF0Y2hfZmFpbGVkJywgb25CYXRjaEZhaWxlZCk7XG5cbiAgICBjb25zdCBjbGk6IE1hdHJpeENsaWVudCA9IGNyZWF0ZUNsaWVudCh7XG4gICAgICAgIGJhc2VVcmw6IGNvbmZpZ1snaHNfdXJsJ10sXG4gICAgICAgIGlkQmFzZVVybDogJycsXG4gICAgICAgIHVzZXJJZDogY29uZmlnWyd1c2VyX2lkJ10sXG4gICAgICAgIGRldmljZUlkOiBjb25maWdbJ2RldmljZV9pZCddLFxuICAgICAgICBhY2Nlc3NUb2tlbjogY29uZmlnWydhY2Nlc3NfdG9rZW4nXSxcbiAgICAgICAgdXNlQXV0aG9yaXphdGlvbkhlYWRlcjogdHJ1ZSxcbiAgICAgICAgc3RvcmU6IG5ldyBNYXRyaXhJbk1lbW9yeVN0b3JlKHtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZTogZ2xvYmFsLmxvY2FsU3RvcmFnZSxcbiAgICAgICAgfSksXG4gICAgICAgIHNlc3Npb25TdG9yZTogbmV3IFdlYlN0b3JhZ2VTZXNzaW9uU3RvcmUoZ2xvYmFsLmxvY2FsU3RvcmFnZSksXG4gICAgfSk7XG5cbiAgICBjbGkub24oJ2V2ZW50JywgKGV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQuaXNFbmNyeXB0ZWQoKSkgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IGNldiA9IGV2ZW50LmdldENsZWFyRXZlbnQoKTtcbiAgICAgICAgLy8gaWYgZXZlbnQgY2FuIGJlIHJlZGFjdGVkIG9yIGlzIGEgcmVkYWN0aW9uIHRoZW4gZW5xdWV1ZSBpdCBmb3IgcHJvY2Vzc2luZ1xuICAgICAgICBpZiAoZXZlbnQuZ2V0VHlwZSgpID09PSBcIm0ucm9vbS5yZWRhY3Rpb25cIiB8fCAhaW5kZXhhYmxlKGNldikpIHJldHVybjtcbiAgICAgICAgcmV0dXJuIHEucHVzaChjZXYpO1xuICAgIH0pO1xuICAgIGNsaS5vbignRXZlbnQuZGVjcnlwdGVkJywgKGV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQuaXNEZWNyeXB0aW9uRmFpbHVyZSgpKSB7XG4gICAgICAgICAgICBsb2dnZXIud2FybignZGVjcnlwdGlvbiBmYWlsdXJlJywge2V2ZW50OiBldmVudC5ldmVudH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2V2ID0gZXZlbnQuZ2V0Q2xlYXJFdmVudCgpO1xuICAgICAgICBpZiAoIWluZGV4YWJsZShjZXYpKSByZXR1cm47XG4gICAgICAgIHJldHVybiBxLnB1c2goY2V2KTtcbiAgICB9KTtcblxuICAgIC8vIGNsaS5vbignUm9vbS5yZWRhY3Rpb24nLCAoZXZlbnQ6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgLy8gICAgIHJldHVybiBxLnB1c2goe1xuICAgIC8vICAgICAgICAgdHlwZTogSm9iVHlwZS5yZWRhY3QsXG4gICAgLy8gICAgICAgICBldmVudDogZXZlbnQuZ2V0Q2xlYXJFdmVudCgpLFxuICAgIC8vICAgICB9KTtcbiAgICAvLyB9KTtcblxuICAgIHRyeSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdpbml0aWFsaXppbmcgY3J5cHRvJyk7XG4gICAgICAgIGF3YWl0IGNsaS5pbml0Q3J5cHRvKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdmYWlsZWQgdG8gaW5pdCBjcnlwdG8nLCB7ZXJyb3J9KTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oJ2NyeXB0byBpbml0aWFsaXplZCcpO1xuXG4gICAgLy8gY3JlYXRlIHN5bmMgZmlsdGVyXG4gICAgY29uc3QgZmlsdGVyID0gbmV3IEZpbHRlcihjbGkuY3JlZGVudGlhbHMudXNlcklkKTtcbiAgICBmaWx0ZXIuc2V0RGVmaW5pdGlvbih7XG4gICAgICAgIHJvb206IHtcbiAgICAgICAgICAgIGluY2x1ZGVfbGVhdmU6IGZhbHNlLCAvLyBUT0RPOiBub3Qgc3VyZSBoZXJlXG4gICAgICAgICAgICAvLyBlcGhlbWVyYWw6IEZJTFRFUl9CTE9DSywgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBlcGhlbWVyYWwgZXZlbnRzXG4gICAgICAgICAgICBhY2NvdW50X2RhdGE6IEZJTFRFUl9CTE9DSywgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCByb29tIGFjY291bnRfZGF0YVxuICAgICAgICAgICAgLy8gc3RhdGU6IEZJTFRFUl9CTE9DSywgLy8gVE9ETzogZG8gd2UgY2FyZSBhYm91dCBzdGF0ZVxuICAgICAgICAgICAgdGltZWxpbmU6IHsgLy8gVE9ETyBkbyB3ZSB3YW50IGFsbCB0aW1lbGluZSBldnNcbiAgICAgICAgICAgICAgICBsaW1pdDogMjAsIC8vIGdyYWIgbW9yZSBldmVudHMgZm9yIGVhY2ggcm9vbSB0byBiZWdpbiB3aXRoXG4gICAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBwcmVzZW5jZTogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IHByZXNlbmNlXG4gICAgICAgIGFjY291bnRfZGF0YTogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGdsb2JhbCBhY2NvdW50X2RhdGFcbiAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdsb2FkaW5nL2NyZWF0aW5nIHN5bmMgZmlsdGVyJyk7XG4gICAgICAgIGZpbHRlci5maWx0ZXJJZCA9IGF3YWl0IGNsaS5nZXRPckNyZWF0ZUZpbHRlcihmaWx0ZXJOYW1lKGNsaSksIGZpbHRlcik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdmYWlsZWQgdG8gZ2V0T3JDcmVhdGUgc3luYyBmaWx0ZXInLCB7ZXJyb3J9KTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oJ3N5bmMgZmlsdGVyIGxvYWRlZCcsIHtmaWx0ZXJfaWQ6IGZpbHRlci5nZXRGaWx0ZXJJZCgpfSk7XG5cbiAgICBsb2dnZXIuaW5mbygnc3RhcnRpbmcgY2xpZW50Jyk7XG4gICAgLy8gZmlsdGVyIHN5bmMgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZVxuICAgIGNsaS5zdGFydENsaWVudCh7XG4gICAgICAgIGRpc2FibGVQcmVzZW5jZTogdHJ1ZSxcbiAgICAgICAgZmlsdGVyLFxuICAgIH0pO1xuICAgIGxvZ2dlci5pbmZvKCdjbGllbnQgc3RhcnRlZCAtIGZldGNoZXIgaGFzIGJlZ3VuJyk7XG59XG5cbi8vIFRPRE8gZ3JvdXBzLXBhZ2luYXRpb25cbi8vIFRPRE8gYmFja2ZpbGxcbi8vIFRPRE8gZ2FwZmlsbFxuXG5mdW5jdGlvbiBmaWx0ZXJOYW1lKGNsaTogTWF0cml4Q2xpZW50KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYE1BVFJJWF9TRUFSQ0hfRklMVEVSXyR7Y2xpLmNyZWRlbnRpYWxzLnVzZXJJZH1gO1xufVxuXG5lbnVtIFJlcXVlc3RLZXkge1xuICAgIGJvZHkgPSBcImNvbnRlbnQuYm9keVwiLFxuICAgIG5hbWUgPSBcImNvbnRlbnQubmFtZVwiLFxuICAgIHRvcGljID0gXCJjb250ZW50LnRvcGljXCIsXG59XG5cbmNvbnN0IGluZGV4YWJsZUtleXMgPSBbUmVxdWVzdEtleS5ib2R5LCBSZXF1ZXN0S2V5Lm5hbWUsIFJlcXVlc3RLZXkudG9waWNdO1xuIl19