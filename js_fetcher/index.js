"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path = __importStar(require("path"));
const yargs_1 = __importDefault(require("yargs"));
const lodash_get_1 = __importDefault(require("lodash.get"));
const winston = __importStar(require("winston"));
// import Olm before importing js-sdk to prevent it crying
global.Olm = require('olm');
const matrix_js_sdk_1 = require("matrix-js-sdk");
// side-effect upgrade MatrixClient prototype
require("./matrix_client_ext");
const fs = __importStar(require("fs"));
const Queue = require('better-queue');
const SqliteStore = require('better-queue-sqlite');
const request = require('request-promise');
const LocalStorageCryptoStore = require('matrix-js-sdk/lib/crypto/store/localStorage-crypto-store').default;
const args = yargs_1.default
    .option('config', {
    alias: 'c',
    description: 'Path to the JSON config file',
    type: 'string',
    required: true,
})
    .option('data', {
    alias: 'd',
    description: 'Path to the data directory',
    type: 'string',
    required: true,
})
    .option('matrix-search-url', {
    alias: 'u',
    description: 'The address:port of the matrix-search Go server',
    type: 'string',
    default: '"http://localhost:8000/api/"',
}).argv;
// Loading localStorage module
if (typeof global.localStorage === "undefined" || global.localStorage === null)
    global.localStorage = new (require('node-localstorage').LocalStorage)(path.join(args['data'], 'js_fetcher.localStorage'));
matrix_js_sdk_1.setCryptoStoreFactory(() => new LocalStorageCryptoStore(global.localStorage));
const logger = new winston.Logger({
    level: 'info',
    transports: [
        new winston.transports.Console({ colorize: true })
    ]
});
class BleveHttp {
    constructor(baseUrl) {
        this.request = request.defaults({ baseUrl });
    }
    enqueue(events) {
        return this.request({
            url: 'enqueue',
            method: 'POST',
            json: true,
            body: events,
        });
    }
}
function indexable(ev) {
    return indexableKeys.some((key) => lodash_get_1.default(ev, key) !== undefined);
}
setup().then();
// debug disable js-sdk log spam
const disableConsoleLogger = false;
if (disableConsoleLogger) {
    console.log = function () { };
    console.warn = function () { };
    console.error = function () { };
    console.error = function () { };
}
const FILTER_BLOCK = {
    not_types: ['*'],
    limit: 0,
};
function onTaskQueued(task_id, ev) {
    const { room_id, event_id, sender, type } = ev;
    if (ev.redacts) {
        logger.info('enqueue event for redaction', { room_id, event_id, task_id });
    }
    else {
        logger.info('enqueue event for indexing', { room_id, event_id, sender, type, task_id });
    }
}
function onBatchFailed(error) {
    logger.error('batch failed', { error });
}
async function setup() {
    let config;
    try {
        const file = fs.readFileSync(args['config'], 'utf8');
        config = JSON.parse(file);
    }
    catch (e) {
        logger.error('failed to load config', e);
        return;
    }
    const b = new BleveHttp(args['matrix-search-url']);
    const q = new Queue(async (batch, cb) => {
        try {
            cb(null, await b.enqueue(batch));
        }
        catch (e) {
            cb(e);
        }
    }, {
        batchSize: 100,
        maxRetries: 100,
        retryDelay: 5000,
        store: new SqliteStore({
            path: path.join(args['data'], 'js_fetcher.queue.sqlite'),
        }),
    });
    q.on('task_queued', onTaskQueued);
    q.on('batch_failed', onBatchFailed);
    const cli = matrix_js_sdk_1.createClient({
        baseUrl: config['hs_url'],
        idBaseUrl: '',
        userId: config['user_id'],
        deviceId: config['device_id'],
        accessToken: config['access_token'],
        useAuthorizationHeader: true,
        store: new matrix_js_sdk_1.MatrixInMemoryStore({
            localStorage: global.localStorage,
        }),
        sessionStore: new matrix_js_sdk_1.WebStorageSessionStore(global.localStorage),
    });
    cli.on('event', (event) => {
        if (event.isEncrypted())
            return;
        const cev = event.getClearEvent();
        // if event can be redacted or is a redaction then enqueue it for processing
        if (event.getType() === "m.room.redaction" || !indexable(cev))
            return;
        return q.push(cev);
    });
    cli.on('Event.decrypted', (event) => {
        if (event.isDecryptionFailure()) {
            logger.warn('decryption failure', { event: event.event });
            return;
        }
        const cev = event.getClearEvent();
        if (!indexable(cev))
            return;
        return q.push(cev);
    });
    // cli.on('Room.redaction', (event: MatrixEvent) => {
    //     return q.push({
    //         type: JobType.redact,
    //         event: event.getClearEvent(),
    //     });
    // });
    try {
        logger.info('initializing crypto');
        await cli.initCrypto();
    }
    catch (error) {
        logger.error('failed to init crypto', { error });
        process.exit(-1);
    }
    logger.info('crypto initialized');
    // create sync filter
    const filter = new matrix_js_sdk_1.Filter(cli.credentials.userId);
    filter.setDefinition({
        room: {
            include_leave: false,
            // ephemeral: FILTER_BLOCK, // we don't care about ephemeral events
            account_data: FILTER_BLOCK,
            // state: FILTER_BLOCK, // TODO: do we care about state
            timeline: {
                limit: 20,
            },
        },
        presence: FILTER_BLOCK,
        account_data: FILTER_BLOCK,
    });
    try {
        logger.info('loading/creating sync filter');
        filter.filterId = await cli.getOrCreateFilter(filterName(cli), filter);
    }
    catch (error) {
        logger.error('failed to getOrCreate sync filter', { error });
        process.exit(-1);
    }
    logger.info('sync filter loaded', { filter_id: filter.getFilterId() });
    logger.info('starting client');
    // filter sync to improve performance
    cli.startClient({
        disablePresence: true,
        filter,
    });
    logger.info('client started - fetcher has begun');
}
// TODO groups-pagination
// TODO backfill
// TODO gapfill
function filterName(cli) {
    return `MATRIX_SEARCH_FILTER_${cli.credentials.userId}`;
}
var RequestKey;
(function (RequestKey) {
    RequestKey["body"] = "content.body";
    RequestKey["name"] = "content.name";
    RequestKey["topic"] = "content.topic";
})(RequestKey || (RequestKey = {}));
const indexableKeys = [RequestKey.body, RequestKey.name, RequestKey.topic];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNkI7QUFRN0Isa0RBQTBCO0FBQzFCLDREQUE2QjtBQUM3QixpREFBbUM7QUFJbkMsMERBQTBEO0FBQzFELE1BQU0sQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRTVCLGlEQWdCdUI7QUFDdkIsNkNBQTZDO0FBQzdDLCtCQUE2QjtBQUM3Qix1Q0FBeUI7QUFFekIsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQ3RDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ25ELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRTNDLE1BQU0sdUJBQXVCLEdBQUcsT0FBTyxDQUFDLDBEQUEwRCxDQUFDLENBQUMsT0FBTyxDQUFDO0FBRzVHLE1BQU0sSUFBSSxHQUFHLGVBQUs7S0FDYixNQUFNLENBQUMsUUFBUSxFQUFFO0lBQ2QsS0FBSyxFQUFFLEdBQUc7SUFDVixXQUFXLEVBQUUsOEJBQThCO0lBQzNDLElBQUksRUFBRSxRQUFRO0lBQ2QsUUFBUSxFQUFFLElBQUk7Q0FDakIsQ0FBQztLQUNELE1BQU0sQ0FBQyxNQUFNLEVBQUU7SUFDWixLQUFLLEVBQUUsR0FBRztJQUNWLFdBQVcsRUFBRSw0QkFBNEI7SUFDekMsSUFBSSxFQUFFLFFBQVE7SUFDZCxRQUFRLEVBQUUsSUFBSTtDQUNqQixDQUFDO0tBQ0QsTUFBTSxDQUFDLG1CQUFtQixFQUFFO0lBQ3pCLEtBQUssRUFBRSxHQUFHO0lBQ1YsV0FBVyxFQUFFLGlEQUFpRDtJQUM5RCxJQUFJLEVBQUUsUUFBUTtJQUNkLE9BQU8sRUFBRSw4QkFBOEI7Q0FDMUMsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUVaLDhCQUE4QjtBQUM5QixJQUFJLE9BQU8sTUFBTSxDQUFDLFlBQVksS0FBSyxXQUFXLElBQUksTUFBTSxDQUFDLFlBQVksS0FBSyxJQUFJO0lBQzFFLE1BQU0sQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLHlCQUF5QixDQUFDLENBQUMsQ0FBQztBQUU5SCxxQ0FBcUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0FBRzlFLE1BQU0sTUFBTSxHQUFHLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQztJQUM5QixLQUFLLEVBQUUsTUFBTTtJQUNiLFVBQVUsRUFBRTtRQUNSLElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBQyxRQUFRLEVBQUUsSUFBSSxFQUFDLENBQUM7S0FDbkQ7Q0FDSixDQUFDLENBQUM7QUFFSDtJQUdJLFlBQVksT0FBZTtRQUN2QixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBQyxPQUFPLEVBQUMsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxPQUFPLENBQUMsTUFBb0I7UUFDeEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ2hCLEdBQUcsRUFBRSxTQUFTO1lBQ2QsTUFBTSxFQUFFLE1BQU07WUFDZCxJQUFJLEVBQUUsSUFBSTtZQUNWLElBQUksRUFBRSxNQUFNO1NBQ2YsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBRUQsbUJBQW1CLEVBQVM7SUFDeEIsT0FBTyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBVyxFQUFFLEVBQUUsQ0FBQyxvQkFBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQztBQUMzRSxDQUFDO0FBRUQsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUM7QUFFZixnQ0FBZ0M7QUFDaEMsTUFBTSxvQkFBb0IsR0FBRyxLQUFLLENBQUM7QUFDbkMsSUFBSSxvQkFBb0IsRUFBRTtJQUN0QixPQUFPLENBQUMsR0FBRyxHQUFHLGNBQVcsQ0FBQyxDQUFDO0lBQzNCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsY0FBVyxDQUFDLENBQUM7SUFDNUIsT0FBTyxDQUFDLEtBQUssR0FBRyxjQUFXLENBQUMsQ0FBQztJQUM3QixPQUFPLENBQUMsS0FBSyxHQUFHLGNBQVcsQ0FBQyxDQUFDO0NBQ2hDO0FBRUQsTUFBTSxZQUFZLEdBQUc7SUFDakIsU0FBUyxFQUFFLENBQUMsR0FBRyxDQUFDO0lBQ2hCLEtBQUssRUFBRSxDQUFDO0NBQ1gsQ0FBQztBQUVGLHNCQUFzQixPQUFlLEVBQUUsRUFBUztJQUM1QyxNQUFNLEVBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzdDLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRTtRQUNaLE1BQU0sQ0FBQyxJQUFJLENBQUMsNkJBQTZCLEVBQUUsRUFBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBQyxDQUFDLENBQUM7S0FDNUU7U0FBTTtRQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsRUFBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFDLENBQUMsQ0FBQztLQUN6RjtBQUNMLENBQUM7QUFFRCx1QkFBdUIsS0FBSztJQUN4QixNQUFNLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRSxFQUFDLEtBQUssRUFBQyxDQUFDLENBQUM7QUFDMUMsQ0FBQztBQUVELEtBQUs7SUFDRCxJQUFJLE1BQU0sQ0FBQztJQUNYLElBQUk7UUFDQSxNQUFNLElBQUksR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNyRCxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUM3QjtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsTUFBTSxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN6QyxPQUFPO0tBQ1Y7SUFFRCxNQUFNLENBQUMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO0lBRW5ELE1BQU0sQ0FBQyxHQUFHLElBQUksS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFtQixFQUFFLEVBQUUsRUFBRSxFQUFFO1FBQ2xELElBQUk7WUFDQSxFQUFFLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ3BDO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDUixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDVDtJQUNMLENBQUMsRUFBRTtRQUNDLFNBQVMsRUFBRSxHQUFHO1FBQ2QsVUFBVSxFQUFFLEdBQUc7UUFDZixVQUFVLEVBQUUsSUFBSTtRQUNoQixLQUFLLEVBQUUsSUFBSSxXQUFXLENBQUM7WUFDbkIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLHlCQUF5QixDQUFDO1NBQzNELENBQUM7S0FDTCxDQUFDLENBQUM7SUFFSCxDQUFDLENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSxZQUFZLENBQUMsQ0FBQztJQUNsQyxDQUFDLENBQUMsRUFBRSxDQUFDLGNBQWMsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUVwQyxNQUFNLEdBQUcsR0FBaUIsNEJBQVksQ0FBQztRQUNuQyxPQUFPLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQztRQUN6QixTQUFTLEVBQUUsRUFBRTtRQUNiLE1BQU0sRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDO1FBQ3pCLFFBQVEsRUFBRSxNQUFNLENBQUMsV0FBVyxDQUFDO1FBQzdCLFdBQVcsRUFBRSxNQUFNLENBQUMsY0FBYyxDQUFDO1FBQ25DLHNCQUFzQixFQUFFLElBQUk7UUFDNUIsS0FBSyxFQUFFLElBQUksbUNBQW1CLENBQUM7WUFDM0IsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZO1NBQ3BDLENBQUM7UUFDRixZQUFZLEVBQUUsSUFBSSxzQ0FBc0IsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO0tBQ2hFLENBQUMsQ0FBQztJQUVILEdBQUcsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBa0IsRUFBRSxFQUFFO1FBQ25DLElBQUksS0FBSyxDQUFDLFdBQVcsRUFBRTtZQUFFLE9BQU87UUFFaEMsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ2xDLDRFQUE0RTtRQUM1RSxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsS0FBSyxrQkFBa0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUM7WUFBRSxPQUFPO1FBQ3RFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2QixDQUFDLENBQUMsQ0FBQztJQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxLQUFrQixFQUFFLEVBQUU7UUFDN0MsSUFBSSxLQUFLLENBQUMsbUJBQW1CLEVBQUUsRUFBRTtZQUM3QixNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLEVBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUMsQ0FBQyxDQUFDO1lBQ3hELE9BQU87U0FDVjtRQUVELE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNsQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQztZQUFFLE9BQU87UUFDNUIsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBRUgscURBQXFEO0lBQ3JELHNCQUFzQjtJQUN0QixnQ0FBZ0M7SUFDaEMsd0NBQXdDO0lBQ3hDLFVBQVU7SUFDVixNQUFNO0lBRU4sSUFBSTtRQUNBLE1BQU0sQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUNuQyxNQUFNLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQztLQUMxQjtJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ1osTUFBTSxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsRUFBRSxFQUFDLEtBQUssRUFBQyxDQUFDLENBQUM7UUFDL0MsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3BCO0lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBRWxDLHFCQUFxQjtJQUNyQixNQUFNLE1BQU0sR0FBRyxJQUFJLHNCQUFNLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsRCxNQUFNLENBQUMsYUFBYSxDQUFDO1FBQ2pCLElBQUksRUFBRTtZQUNGLGFBQWEsRUFBRSxLQUFLO1lBQ3BCLG1FQUFtRTtZQUNuRSxZQUFZLEVBQUUsWUFBWTtZQUMxQix1REFBdUQ7WUFDdkQsUUFBUSxFQUFFO2dCQUNOLEtBQUssRUFBRSxFQUFFO2FBQ1o7U0FDSjtRQUNELFFBQVEsRUFBRSxZQUFZO1FBQ3RCLFlBQVksRUFBRSxZQUFZO0tBQzdCLENBQUMsQ0FBQztJQUVILElBQUk7UUFDQSxNQUFNLENBQUMsSUFBSSxDQUFDLDhCQUE4QixDQUFDLENBQUM7UUFDNUMsTUFBTSxDQUFDLFFBQVEsR0FBRyxNQUFNLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDMUU7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNaLE1BQU0sQ0FBQyxLQUFLLENBQUMsbUNBQW1DLEVBQUUsRUFBQyxLQUFLLEVBQUMsQ0FBQyxDQUFDO1FBQzNELE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNwQjtJQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsRUFBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLFdBQVcsRUFBRSxFQUFDLENBQUMsQ0FBQztJQUVyRSxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDL0IscUNBQXFDO0lBQ3JDLEdBQUcsQ0FBQyxXQUFXLENBQUM7UUFDWixlQUFlLEVBQUUsSUFBSTtRQUNyQixNQUFNO0tBQ1QsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0FBQ3RELENBQUM7QUFFRCx5QkFBeUI7QUFDekIsZ0JBQWdCO0FBQ2hCLGVBQWU7QUFFZixvQkFBb0IsR0FBaUI7SUFDakMsT0FBTyx3QkFBd0IsR0FBRyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUM1RCxDQUFDO0FBRUQsSUFBSyxVQUlKO0FBSkQsV0FBSyxVQUFVO0lBQ1gsbUNBQXFCLENBQUE7SUFDckIsbUNBQXFCLENBQUE7SUFDckIscUNBQXVCLENBQUE7QUFDM0IsQ0FBQyxFQUpJLFVBQVUsS0FBVixVQUFVLFFBSWQ7QUFFRCxNQUFNLGFBQWEsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5cbmRlY2xhcmUgdmFyIGdsb2JhbDoge1xuICAgIE9sbTogYW55XG4gICAgbG9jYWxTdG9yYWdlPzogYW55XG4gICAgYXRvYjogKHN0cmluZykgPT4gc3RyaW5nO1xufTtcblxuaW1wb3J0IHlhcmdzIGZyb20gJ3lhcmdzJztcbmltcG9ydCBnZXQgZnJvbSAnbG9kYXNoLmdldCc7XG5pbXBvcnQgKiBhcyB3aW5zdG9uIGZyb20gJ3dpbnN0b24nO1xuaW1wb3J0IHtSZXF1ZXN0UHJvbWlzZSwgUmVxdWVzdFByb21pc2VPcHRpb25zfSBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHtSZXF1ZXN0QVBJLCBSZXF1aXJlZFVyaVVybH0gZnJvbSAncmVxdWVzdCc7XG5cbi8vIGltcG9ydCBPbG0gYmVmb3JlIGltcG9ydGluZyBqcy1zZGsgdG8gcHJldmVudCBpdCBjcnlpbmdcbmdsb2JhbC5PbG0gPSByZXF1aXJlKCdvbG0nKTtcblxuaW1wb3J0IHtcbiAgICBSb29tLFxuICAgIEV2ZW50LFxuICAgIEZpbHRlcixcbiAgICBNYXRyaXgsXG4gICAgTWF0cml4RXZlbnQsXG4gICAgVXNlclByb2ZpbGUsXG4gICAgY3JlYXRlQ2xpZW50LFxuICAgIEV2ZW50Q29udGV4dCxcbiAgICBNYXRyaXhDbGllbnQsXG4gICAgSW5kZXhlZERCU3RvcmUsXG4gICAgRXZlbnRXaXRoQ29udGV4dCxcbiAgICBNYXRyaXhJbk1lbW9yeVN0b3JlLFxuICAgIEluZGV4ZWREQkNyeXB0b1N0b3JlLFxuICAgIHNldENyeXB0b1N0b3JlRmFjdG9yeSxcbiAgICBXZWJTdG9yYWdlU2Vzc2lvblN0b3JlLFxufSBmcm9tICdtYXRyaXgtanMtc2RrJztcbi8vIHNpZGUtZWZmZWN0IHVwZ3JhZGUgTWF0cml4Q2xpZW50IHByb3RvdHlwZVxuaW1wb3J0ICcuL21hdHJpeF9jbGllbnRfZXh0JztcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuXG5jb25zdCBRdWV1ZSA9IHJlcXVpcmUoJ2JldHRlci1xdWV1ZScpO1xuY29uc3QgU3FsaXRlU3RvcmUgPSByZXF1aXJlKCdiZXR0ZXItcXVldWUtc3FsaXRlJyk7XG5jb25zdCByZXF1ZXN0ID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlJyk7XG5cbmNvbnN0IExvY2FsU3RvcmFnZUNyeXB0b1N0b3JlID0gcmVxdWlyZSgnbWF0cml4LWpzLXNkay9saWIvY3J5cHRvL3N0b3JlL2xvY2FsU3RvcmFnZS1jcnlwdG8tc3RvcmUnKS5kZWZhdWx0O1xuXG5cbmNvbnN0IGFyZ3MgPSB5YXJnc1xuICAgIC5vcHRpb24oJ2NvbmZpZycsIHtcbiAgICAgICAgYWxpYXM6ICdjJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdQYXRoIHRvIHRoZSBKU09OIGNvbmZpZyBmaWxlJyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgIH0pXG4gICAgLm9wdGlvbignZGF0YScsIHtcbiAgICAgICAgYWxpYXM6ICdkJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdQYXRoIHRvIHRoZSBkYXRhIGRpcmVjdG9yeScsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICByZXF1aXJlZDogdHJ1ZSxcbiAgICB9KVxuICAgIC5vcHRpb24oJ21hdHJpeC1zZWFyY2gtdXJsJywge1xuICAgICAgICBhbGlhczogJ3UnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBhZGRyZXNzOnBvcnQgb2YgdGhlIG1hdHJpeC1zZWFyY2ggR28gc2VydmVyJyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGRlZmF1bHQ6ICdcImh0dHA6Ly9sb2NhbGhvc3Q6ODAwMC9hcGkvXCInLFxuICAgIH0pLmFyZ3Y7XG5cbi8vIExvYWRpbmcgbG9jYWxTdG9yYWdlIG1vZHVsZVxuaWYgKHR5cGVvZiBnbG9iYWwubG9jYWxTdG9yYWdlID09PSBcInVuZGVmaW5lZFwiIHx8IGdsb2JhbC5sb2NhbFN0b3JhZ2UgPT09IG51bGwpXG4gICAgZ2xvYmFsLmxvY2FsU3RvcmFnZSA9IG5ldyAocmVxdWlyZSgnbm9kZS1sb2NhbHN0b3JhZ2UnKS5Mb2NhbFN0b3JhZ2UpKHBhdGguam9pbihhcmdzWydkYXRhJ10sICdqc19mZXRjaGVyLmxvY2FsU3RvcmFnZScpKTtcblxuc2V0Q3J5cHRvU3RvcmVGYWN0b3J5KCgpID0+IG5ldyBMb2NhbFN0b3JhZ2VDcnlwdG9TdG9yZShnbG9iYWwubG9jYWxTdG9yYWdlKSk7XG5cblxuY29uc3QgbG9nZ2VyID0gbmV3IHdpbnN0b24uTG9nZ2VyKHtcbiAgICBsZXZlbDogJ2luZm8nLFxuICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKHtjb2xvcml6ZTogdHJ1ZX0pXG4gICAgXVxufSk7XG5cbmNsYXNzIEJsZXZlSHR0cCB7XG4gICAgcmVxdWVzdDogUmVxdWVzdEFQSTxSZXF1ZXN0UHJvbWlzZSwgUmVxdWVzdFByb21pc2VPcHRpb25zLCBSZXF1aXJlZFVyaVVybD47XG5cbiAgICBjb25zdHJ1Y3RvcihiYXNlVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdC5kZWZhdWx0cyh7YmFzZVVybH0pO1xuICAgIH1cblxuICAgIGVucXVldWUoZXZlbnRzOiBBcnJheTxFdmVudD4pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdCh7XG4gICAgICAgICAgICB1cmw6ICdlbnF1ZXVlJyxcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgICAgICAgIGJvZHk6IGV2ZW50cyxcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBpbmRleGFibGUoZXY6IEV2ZW50KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGluZGV4YWJsZUtleXMuc29tZSgoa2V5OiBzdHJpbmcpID0+IGdldChldiwga2V5KSAhPT0gdW5kZWZpbmVkKTtcbn1cblxuc2V0dXAoKS50aGVuKCk7XG5cbi8vIGRlYnVnIGRpc2FibGUganMtc2RrIGxvZyBzcGFtXG5jb25zdCBkaXNhYmxlQ29uc29sZUxvZ2dlciA9IGZhbHNlO1xuaWYgKGRpc2FibGVDb25zb2xlTG9nZ2VyKSB7XG4gICAgY29uc29sZS5sb2cgPSBmdW5jdGlvbigpe307XG4gICAgY29uc29sZS53YXJuID0gZnVuY3Rpb24oKXt9O1xuICAgIGNvbnNvbGUuZXJyb3IgPSBmdW5jdGlvbigpe307XG4gICAgY29uc29sZS5lcnJvciA9IGZ1bmN0aW9uKCl7fTtcbn1cblxuY29uc3QgRklMVEVSX0JMT0NLID0ge1xuICAgIG5vdF90eXBlczogWycqJ10sXG4gICAgbGltaXQ6IDAsXG59O1xuXG5mdW5jdGlvbiBvblRhc2tRdWV1ZWQodGFza19pZDogc3RyaW5nLCBldjogRXZlbnQpIHtcbiAgICBjb25zdCB7cm9vbV9pZCwgZXZlbnRfaWQsIHNlbmRlciwgdHlwZX0gPSBldjtcbiAgICBpZiAoZXYucmVkYWN0cykge1xuICAgICAgICBsb2dnZXIuaW5mbygnZW5xdWV1ZSBldmVudCBmb3IgcmVkYWN0aW9uJywge3Jvb21faWQsIGV2ZW50X2lkLCB0YXNrX2lkfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ2VucXVldWUgZXZlbnQgZm9yIGluZGV4aW5nJywge3Jvb21faWQsIGV2ZW50X2lkLCBzZW5kZXIsIHR5cGUsIHRhc2tfaWR9KTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIG9uQmF0Y2hGYWlsZWQoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ2JhdGNoIGZhaWxlZCcsIHtlcnJvcn0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXR1cCgpIHtcbiAgICBsZXQgY29uZmlnO1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGZpbGUgPSBmcy5yZWFkRmlsZVN5bmMoYXJnc1snY29uZmlnJ10sICd1dGY4Jyk7XG4gICAgICAgIGNvbmZpZyA9IEpTT04ucGFyc2UoZmlsZSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ2ZhaWxlZCB0byBsb2FkIGNvbmZpZycsIGUpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYiA9IG5ldyBCbGV2ZUh0dHAoYXJnc1snbWF0cml4LXNlYXJjaC11cmwnXSk7XG5cbiAgICBjb25zdCBxID0gbmV3IFF1ZXVlKGFzeW5jIChiYXRjaDogQXJyYXk8RXZlbnQ+LCBjYikgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY2IobnVsbCwgYXdhaXQgYi5lbnF1ZXVlKGJhdGNoKSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGNiKGUpO1xuICAgICAgICB9XG4gICAgfSwge1xuICAgICAgICBiYXRjaFNpemU6IDEwMCxcbiAgICAgICAgbWF4UmV0cmllczogMTAwLFxuICAgICAgICByZXRyeURlbGF5OiA1MDAwLFxuICAgICAgICBzdG9yZTogbmV3IFNxbGl0ZVN0b3JlKHtcbiAgICAgICAgICAgIHBhdGg6IHBhdGguam9pbihhcmdzWydkYXRhJ10sICdqc19mZXRjaGVyLnF1ZXVlLnNxbGl0ZScpLFxuICAgICAgICB9KSxcbiAgICB9KTtcblxuICAgIHEub24oJ3Rhc2tfcXVldWVkJywgb25UYXNrUXVldWVkKTtcbiAgICBxLm9uKCdiYXRjaF9mYWlsZWQnLCBvbkJhdGNoRmFpbGVkKTtcblxuICAgIGNvbnN0IGNsaTogTWF0cml4Q2xpZW50ID0gY3JlYXRlQ2xpZW50KHtcbiAgICAgICAgYmFzZVVybDogY29uZmlnWydoc191cmwnXSxcbiAgICAgICAgaWRCYXNlVXJsOiAnJyxcbiAgICAgICAgdXNlcklkOiBjb25maWdbJ3VzZXJfaWQnXSxcbiAgICAgICAgZGV2aWNlSWQ6IGNvbmZpZ1snZGV2aWNlX2lkJ10sXG4gICAgICAgIGFjY2Vzc1Rva2VuOiBjb25maWdbJ2FjY2Vzc190b2tlbiddLFxuICAgICAgICB1c2VBdXRob3JpemF0aW9uSGVhZGVyOiB0cnVlLFxuICAgICAgICBzdG9yZTogbmV3IE1hdHJpeEluTWVtb3J5U3RvcmUoe1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlOiBnbG9iYWwubG9jYWxTdG9yYWdlLFxuICAgICAgICB9KSxcbiAgICAgICAgc2Vzc2lvblN0b3JlOiBuZXcgV2ViU3RvcmFnZVNlc3Npb25TdG9yZShnbG9iYWwubG9jYWxTdG9yYWdlKSxcbiAgICB9KTtcblxuICAgIGNsaS5vbignZXZlbnQnLCAoZXZlbnQ6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgICAgIGlmIChldmVudC5pc0VuY3J5cHRlZCgpKSByZXR1cm47XG5cbiAgICAgICAgY29uc3QgY2V2ID0gZXZlbnQuZ2V0Q2xlYXJFdmVudCgpO1xuICAgICAgICAvLyBpZiBldmVudCBjYW4gYmUgcmVkYWN0ZWQgb3IgaXMgYSByZWRhY3Rpb24gdGhlbiBlbnF1ZXVlIGl0IGZvciBwcm9jZXNzaW5nXG4gICAgICAgIGlmIChldmVudC5nZXRUeXBlKCkgPT09IFwibS5yb29tLnJlZGFjdGlvblwiIHx8ICFpbmRleGFibGUoY2V2KSkgcmV0dXJuO1xuICAgICAgICByZXR1cm4gcS5wdXNoKGNldik7XG4gICAgfSk7XG4gICAgY2xpLm9uKCdFdmVudC5kZWNyeXB0ZWQnLCAoZXZlbnQ6IE1hdHJpeEV2ZW50KSA9PiB7XG4gICAgICAgIGlmIChldmVudC5pc0RlY3J5cHRpb25GYWlsdXJlKCkpIHtcbiAgICAgICAgICAgIGxvZ2dlci53YXJuKCdkZWNyeXB0aW9uIGZhaWx1cmUnLCB7ZXZlbnQ6IGV2ZW50LmV2ZW50fSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjZXYgPSBldmVudC5nZXRDbGVhckV2ZW50KCk7XG4gICAgICAgIGlmICghaW5kZXhhYmxlKGNldikpIHJldHVybjtcbiAgICAgICAgcmV0dXJuIHEucHVzaChjZXYpO1xuICAgIH0pO1xuXG4gICAgLy8gY2xpLm9uKCdSb29tLnJlZGFjdGlvbicsIChldmVudDogTWF0cml4RXZlbnQpID0+IHtcbiAgICAvLyAgICAgcmV0dXJuIHEucHVzaCh7XG4gICAgLy8gICAgICAgICB0eXBlOiBKb2JUeXBlLnJlZGFjdCxcbiAgICAvLyAgICAgICAgIGV2ZW50OiBldmVudC5nZXRDbGVhckV2ZW50KCksXG4gICAgLy8gICAgIH0pO1xuICAgIC8vIH0pO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ2luaXRpYWxpemluZyBjcnlwdG8nKTtcbiAgICAgICAgYXdhaXQgY2xpLmluaXRDcnlwdG8oKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ2ZhaWxlZCB0byBpbml0IGNyeXB0bycsIHtlcnJvcn0pO1xuICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgIH1cbiAgICBsb2dnZXIuaW5mbygnY3J5cHRvIGluaXRpYWxpemVkJyk7XG5cbiAgICAvLyBjcmVhdGUgc3luYyBmaWx0ZXJcbiAgICBjb25zdCBmaWx0ZXIgPSBuZXcgRmlsdGVyKGNsaS5jcmVkZW50aWFscy51c2VySWQpO1xuICAgIGZpbHRlci5zZXREZWZpbml0aW9uKHtcbiAgICAgICAgcm9vbToge1xuICAgICAgICAgICAgaW5jbHVkZV9sZWF2ZTogZmFsc2UsIC8vIFRPRE86IG5vdCBzdXJlIGhlcmVcbiAgICAgICAgICAgIC8vIGVwaGVtZXJhbDogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGVwaGVtZXJhbCBldmVudHNcbiAgICAgICAgICAgIGFjY291bnRfZGF0YTogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IHJvb20gYWNjb3VudF9kYXRhXG4gICAgICAgICAgICAvLyBzdGF0ZTogRklMVEVSX0JMT0NLLCAvLyBUT0RPOiBkbyB3ZSBjYXJlIGFib3V0IHN0YXRlXG4gICAgICAgICAgICB0aW1lbGluZTogeyAvLyBUT0RPIGRvIHdlIHdhbnQgYWxsIHRpbWVsaW5lIGV2c1xuICAgICAgICAgICAgICAgIGxpbWl0OiAyMCwgLy8gZ3JhYiBtb3JlIGV2ZW50cyBmb3IgZWFjaCByb29tIHRvIGJlZ2luIHdpdGhcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHByZXNlbmNlOiBGSUxURVJfQkxPQ0ssIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgcHJlc2VuY2VcbiAgICAgICAgYWNjb3VudF9kYXRhOiBGSUxURVJfQkxPQ0ssIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgZ2xvYmFsIGFjY291bnRfZGF0YVxuICAgIH0pO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgbG9nZ2VyLmluZm8oJ2xvYWRpbmcvY3JlYXRpbmcgc3luYyBmaWx0ZXInKTtcbiAgICAgICAgZmlsdGVyLmZpbHRlcklkID0gYXdhaXQgY2xpLmdldE9yQ3JlYXRlRmlsdGVyKGZpbHRlck5hbWUoY2xpKSwgZmlsdGVyKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ2ZhaWxlZCB0byBnZXRPckNyZWF0ZSBzeW5jIGZpbHRlcicsIHtlcnJvcn0pO1xuICAgICAgICBwcm9jZXNzLmV4aXQoLTEpO1xuICAgIH1cbiAgICBsb2dnZXIuaW5mbygnc3luYyBmaWx0ZXIgbG9hZGVkJywge2ZpbHRlcl9pZDogZmlsdGVyLmdldEZpbHRlcklkKCl9KTtcblxuICAgIGxvZ2dlci5pbmZvKCdzdGFydGluZyBjbGllbnQnKTtcbiAgICAvLyBmaWx0ZXIgc3luYyB0byBpbXByb3ZlIHBlcmZvcm1hbmNlXG4gICAgY2xpLnN0YXJ0Q2xpZW50KHtcbiAgICAgICAgZGlzYWJsZVByZXNlbmNlOiB0cnVlLFxuICAgICAgICBmaWx0ZXIsXG4gICAgfSk7XG4gICAgbG9nZ2VyLmluZm8oJ2NsaWVudCBzdGFydGVkIC0gZmV0Y2hlciBoYXMgYmVndW4nKTtcbn1cblxuLy8gVE9ETyBncm91cHMtcGFnaW5hdGlvblxuLy8gVE9ETyBiYWNrZmlsbFxuLy8gVE9ETyBnYXBmaWxsXG5cbmZ1bmN0aW9uIGZpbHRlck5hbWUoY2xpOiBNYXRyaXhDbGllbnQpOiBzdHJpbmcge1xuICAgIHJldHVybiBgTUFUUklYX1NFQVJDSF9GSUxURVJfJHtjbGkuY3JlZGVudGlhbHMudXNlcklkfWA7XG59XG5cbmVudW0gUmVxdWVzdEtleSB7XG4gICAgYm9keSA9IFwiY29udGVudC5ib2R5XCIsXG4gICAgbmFtZSA9IFwiY29udGVudC5uYW1lXCIsXG4gICAgdG9waWMgPSBcImNvbnRlbnQudG9waWNcIixcbn1cblxuY29uc3QgaW5kZXhhYmxlS2V5cyA9IFtSZXF1ZXN0S2V5LmJvZHksIFJlcXVlc3RLZXkubmFtZSwgUmVxdWVzdEtleS50b3BpY107XG4iXX0=