"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const argv_1 = __importDefault(require("argv"));
const lodash_get_1 = __importDefault(require("lodash.get"));
const winston = __importStar(require("winston"));
const mkdirp = __importStar(require("mkdirp"));
// import Olm before importing js-sdk to prevent it crying
global.Olm = require('olm');
const matrix_js_sdk_1 = require("matrix-js-sdk");
// side-effect upgrade MatrixClient prototype
require("./matrix_client_ext");
// side-effect upgrade Map and Set prototypes
require("./builtin_ext");
const Queue = require('better-queue');
const SqliteStore = require('better-queue-sqlite');
const request = require('request-promise');
const LocalStorageCryptoStore = require('matrix-js-sdk/lib/crypto/store/localStorage-crypto-store').default;
// create directory which will house the stores.
mkdirp.sync('./store');
// Loading localStorage module
if (typeof global.localStorage === "undefined" || global.localStorage === null)
    global.localStorage = new (require('node-localstorage').LocalStorage)('./store/localStorage');
matrix_js_sdk_1.setCryptoStoreFactory(() => new LocalStorageCryptoStore(global.localStorage));
argv_1.default.option([
    {
        name: 'url',
        type: 'string',
        description: 'The URL to be used to connect to the Matrix HS',
    }, {
        name: 'username',
        type: 'string',
        description: 'The username to be used to connect to the Matrix HS',
    }, {
        name: 'password',
        type: 'string',
        description: 'The password to be used to connect to the Matrix HS',
    }, {
        name: 'port',
        type: 'int',
        description: 'Port to bind to (default 8000)',
    }
]);
const logger = new winston.Logger({
    level: 'info',
    transports: [
        new winston.transports.Console({ colorize: true })
    ]
});
class BleveHttp {
    constructor(baseUrl) {
        this.request = request.defaults({ baseUrl });
    }
    enqueue(events) {
        return this.request({
            url: 'enqueue',
            method: 'POST',
            json: true,
            body: events,
        });
    }
}
const b = new BleveHttp("http://localhost:8000/api/");
function indexable(ev) {
    return indexableKeys.some((key) => lodash_get_1.default(ev, key) !== undefined);
}
const q = new Queue(async (batch, cb) => {
    try {
        cb(null, await b.enqueue(batch));
    }
    catch (e) {
        cb(e);
    }
}, {
    batchSize: 100,
    maxRetries: 100,
    retryDelay: 5000,
    store: new SqliteStore({
        path: './store/queue.sqlite',
    }),
});
q.on('task_queued', function (task_id, ev) {
    const { room_id, event_id, sender, type } = ev;
    if (ev.redacts) {
        logger.info('enqueue event for redaction', { room_id, event_id, task_id });
    }
    else {
        logger.info('enqueue event for indexing', { room_id, event_id, sender, type, task_id });
    }
});
q.on('batch_failed', function (error) {
    logger.error('batch failed', { error });
});
setup().then();
// debug disable js-sdk log spam
const disableConsoleLogger = false;
if (disableConsoleLogger) {
    console.log = function () { };
    console.warn = function () { };
    console.error = function () { };
    console.error = function () { };
}
const FILTER_BLOCK = {
    not_types: ['*'],
    limit: 0,
};
async function setup() {
    const args = argv_1.default.run();
    const baseUrl = args.options['url'] || 'https://matrix.org';
    let creds = {
        userId: global.localStorage.getItem('userId'),
        deviceId: global.localStorage.getItem('deviceId'),
        accessToken: global.localStorage.getItem('accessToken'),
    };
    if (!creds.userId || !creds.deviceId || !creds.accessToken) {
        if (!args.options['username'] || !args.options['password']) {
            logger.error('username and password were not specified on the commandline and none were saved');
            argv_1.default.help();
            process.exit(-1);
        }
        const loginClient = matrix_js_sdk_1.createClient({ baseUrl });
        try {
            const res = await loginClient.login('m.login.password', {
                user: args.options['username'],
                password: args.options['password'],
                initial_device_display_name: 'Matrix Search Daemon',
            });
            logger.info('logged in', { user_id: res.user_id });
            global.localStorage.setItem('userId', res.user_id);
            global.localStorage.setItem('deviceId', res.device_id);
            global.localStorage.setItem('accessToken', res.access_token);
            creds = {
                userId: res.user_id,
                deviceId: res.device_id,
                accessToken: res.access_token,
            };
        }
        catch (error) {
            logger.error('an error occurred logging in', { error });
            process.exit(1);
        }
    }
    const cli = matrix_js_sdk_1.createClient(Object.assign({ baseUrl, idBaseUrl: '' }, creds, { useAuthorizationHeader: true, store: new matrix_js_sdk_1.MatrixInMemoryStore({
            localStorage: global.localStorage,
        }), sessionStore: new matrix_js_sdk_1.WebStorageSessionStore(global.localStorage) }));
    cli.on('event', (event) => {
        if (event.isEncrypted())
            return;
        const cev = event.getClearEvent();
        // if event can be redacted or is a redaction then enqueue it for processing
        if (event.getType() === "m.room.redaction" || !indexable(cev))
            return;
        return q.push(cev);
    });
    cli.on('Event.decrypted', (event) => {
        if (event.isDecryptionFailure()) {
            logger.warn('decryption failure', { event: event.event });
            return;
        }
        const cev = event.getClearEvent();
        if (!indexable(cev))
            return;
        return q.push(cev);
    });
    // cli.on('Room.redaction', (event: MatrixEvent) => {
    //     return q.push({
    //         type: JobType.redact,
    //         event: event.getClearEvent(),
    //     });
    // });
    try {
        logger.info('initializing crypto');
        await cli.initCrypto();
    }
    catch (error) {
        logger.error('failed to init crypto', { error });
        process.exit(-1);
    }
    logger.info('crypto initialized');
    // create sync filter
    const filter = new matrix_js_sdk_1.Filter(cli.credentials.userId);
    filter.setDefinition({
        room: {
            include_leave: false,
            ephemeral: FILTER_BLOCK,
            account_data: FILTER_BLOCK,
        },
        presence: FILTER_BLOCK,
        account_data: FILTER_BLOCK,
    });
    try {
        logger.info('loading/creating sync filter');
        filter.filterId = await cli.getOrCreateFilter(filterName(cli), filter);
    }
    catch (error) {
        logger.error('failed to getOrCreate sync filter', { error });
        process.exit(-1);
    }
    logger.info('sync filter loaded', { filter_id: filter.getFilterId() });
    logger.info('starting client');
    // filter sync to improve performance
    cli.startClient({
        disablePresence: true,
        filter,
    });
    logger.info('client started - fetcher has begun');
}
// TODO groups-pagination
// TODO backfill
// TODO gapfill
function filterName(cli) {
    return `MATRIX_SEARCH_FILTER_${cli.credentials.userId}`;
}
var RequestKey;
(function (RequestKey) {
    RequestKey["body"] = "content.body";
    RequestKey["name"] = "content.name";
    RequestKey["topic"] = "content.topic";
})(RequestKey || (RequestKey = {}));
const indexableKeys = [RequestKey.body, RequestKey.name, RequestKey.topic];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFNQSxnREFBd0I7QUFDeEIsNERBQTZCO0FBQzdCLGlEQUFtQztBQUNuQywrQ0FBaUM7QUFJakMsMERBQTBEO0FBQzFELE1BQU0sQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRTVCLGlEQWdCdUI7QUFDdkIsNkNBQTZDO0FBQzdDLCtCQUE2QjtBQUM3Qiw2Q0FBNkM7QUFDN0MseUJBQXVCO0FBRXZCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUN0QyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUNuRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUUzQyxNQUFNLHVCQUF1QixHQUFHLE9BQU8sQ0FBQywwREFBMEQsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUU1RyxnREFBZ0Q7QUFDaEQsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN2Qiw4QkFBOEI7QUFDOUIsSUFBSSxPQUFPLE1BQU0sQ0FBQyxZQUFZLEtBQUssV0FBVyxJQUFJLE1BQU0sQ0FBQyxZQUFZLEtBQUssSUFBSTtJQUMxRSxNQUFNLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBRWxHLHFDQUFxQixDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksdUJBQXVCLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7QUFFOUUsY0FBSSxDQUFDLE1BQU0sQ0FBQztJQUNSO1FBQ0ksSUFBSSxFQUFFLEtBQUs7UUFDWCxJQUFJLEVBQUUsUUFBUTtRQUNkLFdBQVcsRUFBRSxnREFBZ0Q7S0FDaEUs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SSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDL0IscUNBQXFDO0lBQ3JDLEdBQUcsQ0FBQyxXQUFXLENBQUM7UUFDWixlQUFlLEVBQUUsSUFBSTtRQUNyQixNQUFNO0tBQ1QsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0FBQ3RELENBQUM7QUFFRCx5QkFBeUI7QUFDekIsZ0JBQWdCO0FBQ2hCLGVBQWU7QUFFZixvQkFBb0IsR0FBaUI7SUFDakMsT0FBTyx3QkFBd0IsR0FBRyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUM1RCxDQUFDO0FBRUQsSUFBSyxVQUlKO0FBSkQsV0FBSyxVQUFVO0lBQ1gsbUNBQXFCLENBQUE7SUFDckIsbUNBQXFCLENBQUE7SUFDckIscUNBQXVCLENBQUE7QUFDM0IsQ0FBQyxFQUpJLFVBQVUsS0FBVixVQUFVLFFBSWQ7QUFFRCxNQUFNLGFBQWEsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJkZWNsYXJlIHZhciBnbG9iYWw6IHtcbiAgICBPbG06IGFueVxuICAgIGxvY2FsU3RvcmFnZT86IGFueVxuICAgIGF0b2I6IChzdHJpbmcpID0+IHN0cmluZztcbn07XG5cbmltcG9ydCBhcmd2IGZyb20gJ2FyZ3YnO1xuaW1wb3J0IGdldCBmcm9tICdsb2Rhc2guZ2V0JztcbmltcG9ydCAqIGFzIHdpbnN0b24gZnJvbSAnd2luc3Rvbic7XG5pbXBvcnQgKiBhcyBta2RpcnAgZnJvbSAnbWtkaXJwJztcbmltcG9ydCB7UmVxdWVzdFByb21pc2UsIFJlcXVlc3RQcm9taXNlT3B0aW9uc30gZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCB7UmVxdWVzdEFQSSwgUmVxdWlyZWRVcmlVcmx9IGZyb20gJ3JlcXVlc3QnO1xuXG4vLyBpbXBvcnQgT2xtIGJlZm9yZSBpbXBvcnRpbmcganMtc2RrIHRvIHByZXZlbnQgaXQgY3J5aW5nXG5nbG9iYWwuT2xtID0gcmVxdWlyZSgnb2xtJyk7XG5cbmltcG9ydCB7XG4gICAgUm9vbSxcbiAgICBFdmVudCxcbiAgICBGaWx0ZXIsXG4gICAgTWF0cml4LFxuICAgIE1hdHJpeEV2ZW50LFxuICAgIFVzZXJQcm9maWxlLFxuICAgIGNyZWF0ZUNsaWVudCxcbiAgICBFdmVudENvbnRleHQsXG4gICAgTWF0cml4Q2xpZW50LFxuICAgIEluZGV4ZWREQlN0b3JlLFxuICAgIEV2ZW50V2l0aENvbnRleHQsXG4gICAgTWF0cml4SW5NZW1vcnlTdG9yZSxcbiAgICBJbmRleGVkREJDcnlwdG9TdG9yZSxcbiAgICBzZXRDcnlwdG9TdG9yZUZhY3RvcnksXG4gICAgV2ViU3RvcmFnZVNlc3Npb25TdG9yZSxcbn0gZnJvbSAnbWF0cml4LWpzLXNkayc7XG4vLyBzaWRlLWVmZmVjdCB1cGdyYWRlIE1hdHJpeENsaWVudCBwcm90b3R5cGVcbmltcG9ydCAnLi9tYXRyaXhfY2xpZW50X2V4dCc7XG4vLyBzaWRlLWVmZmVjdCB1cGdyYWRlIE1hcCBhbmQgU2V0IHByb3RvdHlwZXNcbmltcG9ydCAnLi9idWlsdGluX2V4dCc7XG5cbmNvbnN0IFF1ZXVlID0gcmVxdWlyZSgnYmV0dGVyLXF1ZXVlJyk7XG5jb25zdCBTcWxpdGVTdG9yZSA9IHJlcXVpcmUoJ2JldHRlci1xdWV1ZS1zcWxpdGUnKTtcbmNvbnN0IHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0LXByb21pc2UnKTtcblxuY29uc3QgTG9jYWxTdG9yYWdlQ3J5cHRvU3RvcmUgPSByZXF1aXJlKCdtYXRyaXgtanMtc2RrL2xpYi9jcnlwdG8vc3RvcmUvbG9jYWxTdG9yYWdlLWNyeXB0by1zdG9yZScpLmRlZmF1bHQ7XG5cbi8vIGNyZWF0ZSBkaXJlY3Rvcnkgd2hpY2ggd2lsbCBob3VzZSB0aGUgc3RvcmVzLlxubWtkaXJwLnN5bmMoJy4vc3RvcmUnKTtcbi8vIExvYWRpbmcgbG9jYWxTdG9yYWdlIG1vZHVsZVxuaWYgKHR5cGVvZiBnbG9iYWwubG9jYWxTdG9yYWdlID09PSBcInVuZGVmaW5lZFwiIHx8IGdsb2JhbC5sb2NhbFN0b3JhZ2UgPT09IG51bGwpXG4gICAgZ2xvYmFsLmxvY2FsU3RvcmFnZSA9IG5ldyAocmVxdWlyZSgnbm9kZS1sb2NhbHN0b3JhZ2UnKS5Mb2NhbFN0b3JhZ2UpKCcuL3N0b3JlL2xvY2FsU3RvcmFnZScpO1xuXG5zZXRDcnlwdG9TdG9yZUZhY3RvcnkoKCkgPT4gbmV3IExvY2FsU3RvcmFnZUNyeXB0b1N0b3JlKGdsb2JhbC5sb2NhbFN0b3JhZ2UpKTtcblxuYXJndi5vcHRpb24oW1xuICAgIHtcbiAgICAgICAgbmFtZTogJ3VybCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBVUkwgdG8gYmUgdXNlZCB0byBjb25uZWN0IHRvIHRoZSBNYXRyaXggSFMnLFxuICAgIH0sIHtcbiAgICAgICAgbmFtZTogJ3VzZXJuYW1lJyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIHVzZXJuYW1lIHRvIGJlIHVzZWQgdG8gY29ubmVjdCB0byB0aGUgTWF0cml4IEhTJyxcbiAgICB9LCB7XG4gICAgICAgIG5hbWU6ICdwYXNzd29yZCcsXG4gICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBwYXNzd29yZCB0byBiZSB1c2VkIHRvIGNvbm5lY3QgdG8gdGhlIE1hdHJpeCBIUycsXG4gICAgfSwge1xuICAgICAgICBuYW1lOiAncG9ydCcsXG4gICAgICAgIHR5cGU6ICdpbnQnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1BvcnQgdG8gYmluZCB0byAoZGVmYXVsdCA4MDAwKScsXG4gICAgfVxuXSk7XG5cbmNvbnN0IGxvZ2dlciA9IG5ldyB3aW5zdG9uLkxvZ2dlcih7XG4gICAgbGV2ZWw6ICdpbmZvJyxcbiAgICB0cmFuc3BvcnRzOiBbXG4gICAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSh7Y29sb3JpemU6IHRydWV9KVxuICAgIF1cbn0pO1xuXG5jbGFzcyBCbGV2ZUh0dHAge1xuICAgIHJlcXVlc3Q6IFJlcXVlc3RBUEk8UmVxdWVzdFByb21pc2UsIFJlcXVlc3RQcm9taXNlT3B0aW9ucywgUmVxdWlyZWRVcmlVcmw+O1xuXG4gICAgY29uc3RydWN0b3IoYmFzZVVybDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3QuZGVmYXVsdHMoe2Jhc2VVcmx9KTtcbiAgICB9XG5cbiAgICBlbnF1ZXVlKGV2ZW50czogQXJyYXk8RXZlbnQ+KSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3Qoe1xuICAgICAgICAgICAgdXJsOiAnZW5xdWV1ZScsXG4gICAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICAgIGpzb246IHRydWUsXG4gICAgICAgICAgICBib2R5OiBldmVudHMsXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuY29uc3QgYiA9IG5ldyBCbGV2ZUh0dHAoXCJodHRwOi8vbG9jYWxob3N0OjgwMDAvYXBpL1wiKTtcblxuZnVuY3Rpb24gaW5kZXhhYmxlKGV2OiBFdmVudCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBpbmRleGFibGVLZXlzLnNvbWUoKGtleTogc3RyaW5nKSA9PiBnZXQoZXYsIGtleSkgIT09IHVuZGVmaW5lZCk7XG59XG5cbmNvbnN0IHEgPSBuZXcgUXVldWUoYXN5bmMgKGJhdGNoOiBBcnJheTxFdmVudD4sIGNiKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgICAgY2IobnVsbCwgYXdhaXQgYi5lbnF1ZXVlKGJhdGNoKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjYihlKTtcbiAgICB9XG59LCB7XG4gICAgYmF0Y2hTaXplOiAxMDAsXG4gICAgbWF4UmV0cmllczogMTAwLFxuICAgIHJldHJ5RGVsYXk6IDUwMDAsXG4gICAgc3RvcmU6IG5ldyBTcWxpdGVTdG9yZSh7XG4gICAgICAgIHBhdGg6ICcuL3N0b3JlL3F1ZXVlLnNxbGl0ZScsXG4gICAgfSksXG59KTtcblxucS5vbigndGFza19xdWV1ZWQnLCBmdW5jdGlvbih0YXNrX2lkOiBzdHJpbmcsIGV2OiBFdmVudCkge1xuICAgIGNvbnN0IHtyb29tX2lkLCBldmVudF9pZCwgc2VuZGVyLCB0eXBlfSA9IGV2O1xuICAgIGlmIChldi5yZWRhY3RzKSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdlbnF1ZXVlIGV2ZW50IGZvciByZWRhY3Rpb24nLCB7cm9vbV9pZCwgZXZlbnRfaWQsIHRhc2tfaWR9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuaW5mbygnZW5xdWV1ZSBldmVudCBmb3IgaW5kZXhpbmcnLCB7cm9vbV9pZCwgZXZlbnRfaWQsIHNlbmRlciwgdHlwZSwgdGFza19pZH0pO1xuICAgIH1cbn0pO1xuXG5xLm9uKCdiYXRjaF9mYWlsZWQnLCBmdW5jdGlvbihlcnJvcikge1xuICAgIGxvZ2dlci5lcnJvcignYmF0Y2ggZmFpbGVkJywge2Vycm9yfSk7XG59KTtcblxuc2V0dXAoKS50aGVuKCk7XG5cbi8vIGRlYnVnIGRpc2FibGUganMtc2RrIGxvZyBzcGFtXG5jb25zdCBkaXNhYmxlQ29uc29sZUxvZ2dlciA9IGZhbHNlO1xuaWYgKGRpc2FibGVDb25zb2xlTG9nZ2VyKSB7XG4gICAgY29uc29sZS5sb2cgPSBmdW5jdGlvbigpe307XG4gICAgY29uc29sZS53YXJuID0gZnVuY3Rpb24oKXt9O1xuICAgIGNvbnNvbGUuZXJyb3IgPSBmdW5jdGlvbigpe307XG4gICAgY29uc29sZS5lcnJvciA9IGZ1bmN0aW9uKCl7fTtcbn1cblxuY29uc3QgRklMVEVSX0JMT0NLID0ge1xuICAgIG5vdF90eXBlczogWycqJ10sXG4gICAgbGltaXQ6IDAsXG59O1xuXG5hc3luYyBmdW5jdGlvbiBzZXR1cCgpIHtcbiAgICBjb25zdCBhcmdzID0gYXJndi5ydW4oKTtcblxuICAgIGNvbnN0IGJhc2VVcmwgPSBhcmdzLm9wdGlvbnNbJ3VybCddIHx8ICdodHRwczovL21hdHJpeC5vcmcnO1xuXG4gICAgbGV0IGNyZWRzID0ge1xuICAgICAgICB1c2VySWQ6IGdsb2JhbC5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndXNlcklkJyksXG4gICAgICAgIGRldmljZUlkOiBnbG9iYWwubG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2RldmljZUlkJyksXG4gICAgICAgIGFjY2Vzc1Rva2VuOiBnbG9iYWwubG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2FjY2Vzc1Rva2VuJyksXG4gICAgfTtcblxuICAgIGlmICghY3JlZHMudXNlcklkIHx8ICFjcmVkcy5kZXZpY2VJZCB8fCAhY3JlZHMuYWNjZXNzVG9rZW4pIHtcbiAgICAgICAgaWYgKCFhcmdzLm9wdGlvbnNbJ3VzZXJuYW1lJ10gfHwgIWFyZ3Mub3B0aW9uc1sncGFzc3dvcmQnXSkge1xuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCd1c2VybmFtZSBhbmQgcGFzc3dvcmQgd2VyZSBub3Qgc3BlY2lmaWVkIG9uIHRoZSBjb21tYW5kbGluZSBhbmQgbm9uZSB3ZXJlIHNhdmVkJyk7XG4gICAgICAgICAgICBhcmd2LmhlbHAoKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBsb2dpbkNsaWVudDogTWF0cml4Q2xpZW50ID0gY3JlYXRlQ2xpZW50KHtiYXNlVXJsfSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGxvZ2luQ2xpZW50LmxvZ2luKCdtLmxvZ2luLnBhc3N3b3JkJywge1xuICAgICAgICAgICAgICAgIHVzZXI6IGFyZ3Mub3B0aW9uc1sndXNlcm5hbWUnXSxcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogYXJncy5vcHRpb25zWydwYXNzd29yZCddLFxuICAgICAgICAgICAgICAgIGluaXRpYWxfZGV2aWNlX2Rpc3BsYXlfbmFtZTogJ01hdHJpeCBTZWFyY2ggRGFlbW9uJyxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsb2dnZXIuaW5mbygnbG9nZ2VkIGluJywge3VzZXJfaWQ6IHJlcy51c2VyX2lkfSk7XG4gICAgICAgICAgICBnbG9iYWwubG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3VzZXJJZCcsIHJlcy51c2VyX2lkKTtcbiAgICAgICAgICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZGV2aWNlSWQnLCByZXMuZGV2aWNlX2lkKTtcbiAgICAgICAgICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnYWNjZXNzVG9rZW4nLCByZXMuYWNjZXNzX3Rva2VuKTtcblxuICAgICAgICAgICAgY3JlZHMgPSB7XG4gICAgICAgICAgICAgICAgdXNlcklkOiByZXMudXNlcl9pZCxcbiAgICAgICAgICAgICAgICBkZXZpY2VJZDogcmVzLmRldmljZV9pZCxcbiAgICAgICAgICAgICAgICBhY2Nlc3NUb2tlbjogcmVzLmFjY2Vzc190b2tlbixcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ2FuIGVycm9yIG9jY3VycmVkIGxvZ2dpbmcgaW4nLCB7ZXJyb3J9KTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGNsaTogTWF0cml4Q2xpZW50ID0gY3JlYXRlQ2xpZW50KHtcbiAgICAgICAgYmFzZVVybCxcbiAgICAgICAgaWRCYXNlVXJsOiAnJyxcbiAgICAgICAgLi4uY3JlZHMsXG4gICAgICAgIHVzZUF1dGhvcml6YXRpb25IZWFkZXI6IHRydWUsXG4gICAgICAgIHN0b3JlOiBuZXcgTWF0cml4SW5NZW1vcnlTdG9yZSh7XG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2U6IGdsb2JhbC5sb2NhbFN0b3JhZ2UsXG4gICAgICAgIH0pLFxuICAgICAgICBzZXNzaW9uU3RvcmU6IG5ldyBXZWJTdG9yYWdlU2Vzc2lvblN0b3JlKGdsb2JhbC5sb2NhbFN0b3JhZ2UpLFxuICAgIH0pO1xuXG4gICAgY2xpLm9uKCdldmVudCcsIChldmVudDogTWF0cml4RXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGV2ZW50LmlzRW5jcnlwdGVkKCkpIHJldHVybjtcblxuICAgICAgICBjb25zdCBjZXYgPSBldmVudC5nZXRDbGVhckV2ZW50KCk7XG4gICAgICAgIC8vIGlmIGV2ZW50IGNhbiBiZSByZWRhY3RlZCBvciBpcyBhIHJlZGFjdGlvbiB0aGVuIGVucXVldWUgaXQgZm9yIHByb2Nlc3NpbmdcbiAgICAgICAgaWYgKGV2ZW50LmdldFR5cGUoKSA9PT0gXCJtLnJvb20ucmVkYWN0aW9uXCIgfHwgIWluZGV4YWJsZShjZXYpKSByZXR1cm47XG4gICAgICAgIHJldHVybiBxLnB1c2goY2V2KTtcbiAgICB9KTtcbiAgICBjbGkub24oJ0V2ZW50LmRlY3J5cHRlZCcsIChldmVudDogTWF0cml4RXZlbnQpID0+IHtcbiAgICAgICAgaWYgKGV2ZW50LmlzRGVjcnlwdGlvbkZhaWx1cmUoKSkge1xuICAgICAgICAgICAgbG9nZ2VyLndhcm4oJ2RlY3J5cHRpb24gZmFpbHVyZScsIHtldmVudDogZXZlbnQuZXZlbnR9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNldiA9IGV2ZW50LmdldENsZWFyRXZlbnQoKTtcbiAgICAgICAgaWYgKCFpbmRleGFibGUoY2V2KSkgcmV0dXJuO1xuICAgICAgICByZXR1cm4gcS5wdXNoKGNldik7XG4gICAgfSk7XG5cbiAgICAvLyBjbGkub24oJ1Jvb20ucmVkYWN0aW9uJywgKGV2ZW50OiBNYXRyaXhFdmVudCkgPT4ge1xuICAgIC8vICAgICByZXR1cm4gcS5wdXNoKHtcbiAgICAvLyAgICAgICAgIHR5cGU6IEpvYlR5cGUucmVkYWN0LFxuICAgIC8vICAgICAgICAgZXZlbnQ6IGV2ZW50LmdldENsZWFyRXZlbnQoKSxcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gfSk7XG5cbiAgICB0cnkge1xuICAgICAgICBsb2dnZXIuaW5mbygnaW5pdGlhbGl6aW5nIGNyeXB0bycpO1xuICAgICAgICBhd2FpdCBjbGkuaW5pdENyeXB0bygpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignZmFpbGVkIHRvIGluaXQgY3J5cHRvJywge2Vycm9yfSk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XG4gICAgfVxuICAgIGxvZ2dlci5pbmZvKCdjcnlwdG8gaW5pdGlhbGl6ZWQnKTtcblxuICAgIC8vIGNyZWF0ZSBzeW5jIGZpbHRlclxuICAgIGNvbnN0IGZpbHRlciA9IG5ldyBGaWx0ZXIoY2xpLmNyZWRlbnRpYWxzLnVzZXJJZCk7XG4gICAgZmlsdGVyLnNldERlZmluaXRpb24oe1xuICAgICAgICByb29tOiB7XG4gICAgICAgICAgICBpbmNsdWRlX2xlYXZlOiBmYWxzZSwgLy8gVE9ETzogbm90IHN1cmUgaGVyZVxuICAgICAgICAgICAgZXBoZW1lcmFsOiBGSUxURVJfQkxPQ0ssIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgZXBoZW1lcmFsIGV2ZW50c1xuICAgICAgICAgICAgYWNjb3VudF9kYXRhOiBGSUxURVJfQkxPQ0ssIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgcm9vbSBhY2NvdW50X2RhdGFcbiAgICAgICAgICAgIC8vIHN0YXRlOiBGSUxURVJfQkxPQ0ssIC8vIFRPRE86IGRvIHdlIGNhcmUgYWJvdXQgc3RhdGVcbiAgICAgICAgICAgIC8vIHRpbWVsaW5lOiB7IC8vIFRPRE8gZG8gd2Ugd2FudCBhbGwgdGltZWxpbmUgZXZzXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgLy8gfVxuICAgICAgICB9LFxuICAgICAgICBwcmVzZW5jZTogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IHByZXNlbmNlXG4gICAgICAgIGFjY291bnRfZGF0YTogRklMVEVSX0JMT0NLLCAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGdsb2JhbCBhY2NvdW50X2RhdGFcbiAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICAgIGxvZ2dlci5pbmZvKCdsb2FkaW5nL2NyZWF0aW5nIHN5bmMgZmlsdGVyJyk7XG4gICAgICAgIGZpbHRlci5maWx0ZXJJZCA9IGF3YWl0IGNsaS5nZXRPckNyZWF0ZUZpbHRlcihmaWx0ZXJOYW1lKGNsaSksIGZpbHRlcik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdmYWlsZWQgdG8gZ2V0T3JDcmVhdGUgc3luYyBmaWx0ZXInLCB7ZXJyb3J9KTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KC0xKTtcbiAgICB9XG4gICAgbG9nZ2VyLmluZm8oJ3N5bmMgZmlsdGVyIGxvYWRlZCcsIHtmaWx0ZXJfaWQ6IGZpbHRlci5nZXRGaWx0ZXJJZCgpfSk7XG5cbiAgICBsb2dnZXIuaW5mbygnc3RhcnRpbmcgY2xpZW50Jyk7XG4gICAgLy8gZmlsdGVyIHN5bmMgdG8gaW1wcm92ZSBwZXJmb3JtYW5jZVxuICAgIGNsaS5zdGFydENsaWVudCh7XG4gICAgICAgIGRpc2FibGVQcmVzZW5jZTogdHJ1ZSxcbiAgICAgICAgZmlsdGVyLFxuICAgIH0pO1xuICAgIGxvZ2dlci5pbmZvKCdjbGllbnQgc3RhcnRlZCAtIGZldGNoZXIgaGFzIGJlZ3VuJyk7XG59XG5cbi8vIFRPRE8gZ3JvdXBzLXBhZ2luYXRpb25cbi8vIFRPRE8gYmFja2ZpbGxcbi8vIFRPRE8gZ2FwZmlsbFxuXG5mdW5jdGlvbiBmaWx0ZXJOYW1lKGNsaTogTWF0cml4Q2xpZW50KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYE1BVFJJWF9TRUFSQ0hfRklMVEVSXyR7Y2xpLmNyZWRlbnRpYWxzLnVzZXJJZH1gO1xufVxuXG5lbnVtIFJlcXVlc3RLZXkge1xuICAgIGJvZHkgPSBcImNvbnRlbnQuYm9keVwiLFxuICAgIG5hbWUgPSBcImNvbnRlbnQubmFtZVwiLFxuICAgIHRvcGljID0gXCJjb250ZW50LnRvcGljXCIsXG59XG5cbmNvbnN0IGluZGV4YWJsZUtleXMgPSBbUmVxdWVzdEtleS5ib2R5LCBSZXF1ZXN0S2V5Lm5hbWUsIFJlcXVlc3RLZXkudG9waWNdO1xuIl19