"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const matrix_js_sdk_1 = require("matrix-js-sdk");
const utils = require('matrix-js-sdk/src/utils');
// "dumb" mapper because e2e should be decrypted in browser, so we don't lose verification status
function getMapper(cli) {
    return function (plainOldJsObject) {
        return new matrix_js_sdk_1.MatrixEvent(plainOldJsObject);
    };
}
matrix_js_sdk_1.MatrixClient.prototype.fetchEvent = async function (roomId, eventId) {
    const path = utils.encodeUri('/rooms/$roomId/event/$eventId', {
        $roomId: roomId,
        $eventId: eventId,
    });
    let res;
    try {
        res = await this._http.authedRequest(undefined, 'GET', path);
    }
    catch (e) { }
    if (!res)
        throw new Error("'event' not in '/event' result - homeserver too old?");
    return getMapper(this)(res);
};
// XXX: use getEventTimeline once we store rooms properly
matrix_js_sdk_1.MatrixClient.prototype.fetchEventContext = async function (roomId, eventId, limit) {
    const path = utils.encodeUri('/rooms/$roomId/context/$eventId', {
        $roomId: roomId,
        $eventId: eventId,
    });
    let res;
    try {
        res = await this._http.authedRequest(undefined, 'GET', path, { limit });
    }
    catch (e) { }
    if (!res || !res.event)
        throw new Error("'event' not in '/context' result - homeserver too old?");
    // const mapper = this.getEventMapper();
    const mapper = getMapper(this);
    const event = mapper(res.event);
    const state = res.state.map(mapper);
    const events_after = res.events_after.map(mapper);
    const events_before = res.events_before.map(mapper);
    return {
        event,
        context: {
            start: res.start,
            end: res.end,
            state,
            events_after,
            events_before,
        },
    };
};
matrix_js_sdk_1.MatrixEvent.prototype.getClearEvent = function () {
    if (!this.isEncrypted())
        return this.event;
    return Object.assign({}, this.event, this._clearEvent);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0cml4X2NsaWVudF9leHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtYXRyaXhfY2xpZW50X2V4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGlEQUFpRjtBQUVqRixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQztBQUVqRCxpR0FBaUc7QUFDakcsbUJBQW1CLEdBQWlCO0lBQ2hDLE9BQU8sVUFBUyxnQkFBdUI7UUFDbkMsT0FBTyxJQUFJLDJCQUFXLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUM3QyxDQUFDLENBQUE7QUFDTCxDQUFDO0FBRUQsNEJBQVksQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLEtBQUssV0FBVSxNQUFjLEVBQUUsT0FBZTtJQUM5RSxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLCtCQUErQixFQUFFO1FBQzFELE9BQU8sRUFBRSxNQUFNO1FBQ2YsUUFBUSxFQUFFLE9BQU87S0FDcEIsQ0FBQyxDQUFDO0lBRUgsSUFBSSxHQUFHLENBQUM7SUFDUixJQUFJO1FBQ0EsR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztLQUNoRTtJQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUU7SUFFZCxJQUFJLENBQUMsR0FBRztRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsc0RBQXNELENBQUMsQ0FBQztJQUVsRixPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNoQyxDQUFDLENBQUM7QUFFRix5REFBeUQ7QUFDekQsNEJBQVksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxXQUFVLE1BQWMsRUFBRSxPQUFlLEVBQUUsS0FBYTtJQUNwRyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLGlDQUFpQyxFQUFFO1FBQzVELE9BQU8sRUFBRSxNQUFNO1FBQ2YsUUFBUSxFQUFFLE9BQU87S0FDcEIsQ0FBQyxDQUFDO0lBRUgsSUFBSSxHQUFHLENBQUM7SUFDUixJQUFJO1FBQ0EsR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsRUFBQyxLQUFLLEVBQUMsQ0FBQyxDQUFDO0tBQ3pFO0lBQUMsT0FBTyxDQUFDLEVBQUUsR0FBRTtJQUVkLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSztRQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLHdEQUF3RCxDQUFDLENBQUM7SUFFOUUsd0NBQXdDO0lBRXhDLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUUvQixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRWhDLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3BDLE1BQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2xELE1BQU0sYUFBYSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRXBELE9BQU87UUFDSCxLQUFLO1FBQ0wsT0FBTyxFQUFFO1lBQ0wsS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLO1lBQ2hCLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRztZQUNaLEtBQUs7WUFDTCxZQUFZO1lBQ1osYUFBYTtTQUNoQjtLQUNKLENBQUM7QUFDTixDQUFDLENBQUM7QUFFRiwyQkFBVyxDQUFDLFNBQVMsQ0FBQyxhQUFhLEdBQUc7SUFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFBRSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDM0MsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUMzRCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0V2ZW50LCBFdmVudFdpdGhDb250ZXh0LCBNYXRyaXhDbGllbnQsIE1hdHJpeEV2ZW50fSBmcm9tICdtYXRyaXgtanMtc2RrJztcblxuY29uc3QgdXRpbHMgPSByZXF1aXJlKCdtYXRyaXgtanMtc2RrL3NyYy91dGlscycpO1xuXG4vLyBcImR1bWJcIiBtYXBwZXIgYmVjYXVzZSBlMmUgc2hvdWxkIGJlIGRlY3J5cHRlZCBpbiBicm93c2VyLCBzbyB3ZSBkb24ndCBsb3NlIHZlcmlmaWNhdGlvbiBzdGF0dXNcbmZ1bmN0aW9uIGdldE1hcHBlcihjbGk6IE1hdHJpeENsaWVudCkge1xuICAgIHJldHVybiBmdW5jdGlvbihwbGFpbk9sZEpzT2JqZWN0OiBFdmVudCk6IE1hdHJpeEV2ZW50IHtcbiAgICAgICAgcmV0dXJuIG5ldyBNYXRyaXhFdmVudChwbGFpbk9sZEpzT2JqZWN0KTtcbiAgICB9XG59XG5cbk1hdHJpeENsaWVudC5wcm90b3R5cGUuZmV0Y2hFdmVudCA9IGFzeW5jIGZ1bmN0aW9uKHJvb21JZDogc3RyaW5nLCBldmVudElkOiBzdHJpbmcpOiBQcm9taXNlPE1hdHJpeEV2ZW50PiB7XG4gICAgY29uc3QgcGF0aCA9IHV0aWxzLmVuY29kZVVyaSgnL3Jvb21zLyRyb29tSWQvZXZlbnQvJGV2ZW50SWQnLCB7XG4gICAgICAgICRyb29tSWQ6IHJvb21JZCxcbiAgICAgICAgJGV2ZW50SWQ6IGV2ZW50SWQsXG4gICAgfSk7XG5cbiAgICBsZXQgcmVzO1xuICAgIHRyeSB7XG4gICAgICAgIHJlcyA9IGF3YWl0IHRoaXMuX2h0dHAuYXV0aGVkUmVxdWVzdCh1bmRlZmluZWQsICdHRVQnLCBwYXRoKTtcbiAgICB9IGNhdGNoIChlKSB7fVxuXG4gICAgaWYgKCFyZXMpIHRocm93IG5ldyBFcnJvcihcIidldmVudCcgbm90IGluICcvZXZlbnQnIHJlc3VsdCAtIGhvbWVzZXJ2ZXIgdG9vIG9sZD9cIik7XG5cbiAgICByZXR1cm4gZ2V0TWFwcGVyKHRoaXMpKHJlcyk7XG59O1xuXG4vLyBYWFg6IHVzZSBnZXRFdmVudFRpbWVsaW5lIG9uY2Ugd2Ugc3RvcmUgcm9vbXMgcHJvcGVybHlcbk1hdHJpeENsaWVudC5wcm90b3R5cGUuZmV0Y2hFdmVudENvbnRleHQgPSBhc3luYyBmdW5jdGlvbihyb29tSWQ6IHN0cmluZywgZXZlbnRJZDogc3RyaW5nLCBsaW1pdDogbnVtYmVyKTogUHJvbWlzZTxFdmVudFdpdGhDb250ZXh0PiB7XG4gICAgY29uc3QgcGF0aCA9IHV0aWxzLmVuY29kZVVyaSgnL3Jvb21zLyRyb29tSWQvY29udGV4dC8kZXZlbnRJZCcsIHtcbiAgICAgICAgJHJvb21JZDogcm9vbUlkLFxuICAgICAgICAkZXZlbnRJZDogZXZlbnRJZCxcbiAgICB9KTtcblxuICAgIGxldCByZXM7XG4gICAgdHJ5IHtcbiAgICAgICAgcmVzID0gYXdhaXQgdGhpcy5faHR0cC5hdXRoZWRSZXF1ZXN0KHVuZGVmaW5lZCwgJ0dFVCcsIHBhdGgsIHtsaW1pdH0pO1xuICAgIH0gY2F0Y2ggKGUpIHt9XG5cbiAgICBpZiAoIXJlcyB8fCAhcmVzLmV2ZW50KVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCInZXZlbnQnIG5vdCBpbiAnL2NvbnRleHQnIHJlc3VsdCAtIGhvbWVzZXJ2ZXIgdG9vIG9sZD9cIik7XG5cbiAgICAvLyBjb25zdCBtYXBwZXIgPSB0aGlzLmdldEV2ZW50TWFwcGVyKCk7XG5cbiAgICBjb25zdCBtYXBwZXIgPSBnZXRNYXBwZXIodGhpcyk7XG5cbiAgICBjb25zdCBldmVudCA9IG1hcHBlcihyZXMuZXZlbnQpO1xuXG4gICAgY29uc3Qgc3RhdGUgPSByZXMuc3RhdGUubWFwKG1hcHBlcik7XG4gICAgY29uc3QgZXZlbnRzX2FmdGVyID0gcmVzLmV2ZW50c19hZnRlci5tYXAobWFwcGVyKTtcbiAgICBjb25zdCBldmVudHNfYmVmb3JlID0gcmVzLmV2ZW50c19iZWZvcmUubWFwKG1hcHBlcik7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBldmVudCxcbiAgICAgICAgY29udGV4dDoge1xuICAgICAgICAgICAgc3RhcnQ6IHJlcy5zdGFydCxcbiAgICAgICAgICAgIGVuZDogcmVzLmVuZCxcbiAgICAgICAgICAgIHN0YXRlLFxuICAgICAgICAgICAgZXZlbnRzX2FmdGVyLFxuICAgICAgICAgICAgZXZlbnRzX2JlZm9yZSxcbiAgICAgICAgfSxcbiAgICB9O1xufTtcblxuTWF0cml4RXZlbnQucHJvdG90eXBlLmdldENsZWFyRXZlbnQgPSBmdW5jdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuaXNFbmNyeXB0ZWQoKSkgcmV0dXJuIHRoaXMuZXZlbnQ7XG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHRoaXMuZXZlbnQsIHRoaXMuX2NsZWFyRXZlbnQpO1xufTsiXX0=